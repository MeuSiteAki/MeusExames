<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel de Saúde Multi-Pacientes (Protegido)</title>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <!-- CryptoJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root {
      --bg1: #f9fafb; --bg2: #eef2f7; --card: #ffffff; --text: #1f2937;
      --primary: #2563eb; --primary-hover: #1d4ed8; --accent: #111827;
      --blue: #2563eb; --orange: #f97316; --red: #dc2626;
      --blue-bg: #dbeafe; --orange-bg: #ffedd5; --red-bg: #fee2e2;
      --shadow: 0 8px 24px rgba(0, 0, 0, 0.08); --radius: 16px;
    }
    body { margin:0; font-family: 'Inter', 'Segoe UI', Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, var(--bg1), var(--bg2)); min-height: 100vh; color: var(--text); }
    .menu-btn { position: fixed; right: 20px; bottom: 20px; width: 56px; height: 56px; border-radius: 50%; border: none;
      background: var(--primary); color: #fff; font-size: 22px; display: flex; align-items: center; justify-content: center;
      cursor: pointer; box-shadow: var(--shadow); z-index: 1001; transition: transform .25s ease, background .25s ease; }
    .menu-btn:hover { background: var(--primary-hover); transform: rotate(90deg) scale(1.05); }

    .sidebar { position: fixed; left: -305px; top: 0; width: 280px; height: 100vh; background: var(--accent); color: #fff;
      padding: 80px 20px 20px; transition: left .3s ease; z-index: 1000; box-shadow: 12px 0 24px rgba(0,0,0,.25); }
    .sidebar.active { left: 0; }
    .sidebar h3 { margin: 0 0 20px; font-weight: 700; font-size: 18px; display:flex; justify-content:space-between; align-items:center; }
    .nav-link { display:flex; align-items:center; gap:10px; padding:12px 14px; border-radius:10px; color:#e5e7eb; text-decoration:none; margin-bottom:8px; }
    .nav-link:hover { background: rgba(255,255,255,0.1); }
    .nav-link.active { background: rgba(255,255,255,0.2); color:#fff; }

    .container { max-width: 1200px; margin: 30px auto; padding: 0 16px; }
    .header { display:flex; flex-wrap:wrap; gap:20px; justify-content:space-between; margin-bottom:20px; }
    .title-card { flex:1; background: linear-gradient(135deg, #2563eb, #9333ea); color:#fff; padding:20px 28px; border-radius:16px;
      box-shadow: 0 6px 16px rgba(0,0,0,.15); display:flex; align-items:center; justify-content:space-between; }
    .title-card h1 { margin:0; font-size:26px; font-weight:800; }
    .title-actions { display:flex; gap:10px; flex-wrap:wrap; }
    .patient-card { min-width:280px; background:#fff; border-radius:16px; padding:18px 24px; box-shadow: 0 6px 16px rgba(0,0,0,.1); border:1px solid #e5e7eb; }
    .patient-card h2 { margin:0; font-size:20px; font-weight:700; color:#111827; }
    .patient-card p { margin:6px 0 0; font-size:14px; color:#6b7280; }

    .card { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); padding: 24px; }
    .tab { display:none; }
    .tab.active { display:block; }

    .grid { display:grid; grid-template-columns: repeat(2, 1fr); gap:16px; }
    @media (max-width: 700px) { .grid { grid-template-columns: 1fr; } }
    label { font-size:13px; font-weight:600; margin-bottom:6px; display:block; }
    input, select { width:100%; padding:12px; border:1px solid #e5e7eb; border-radius:12px; background:#fff; color:#111827; }
    input::placeholder { color:#9ca3af; }

    .actions { display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; align-items:center; }
    .btn { padding:12px 18px; border:none; border-radius:12px; cursor:pointer; font-weight:600; display:inline-flex; align-items:center; gap:8px; }
    .btn.primary { background: var(--primary); color:#fff; }
    .btn.primary:hover { background: var(--primary-hover); }
    .btn.secondary { background:#f3f4f6; color:#111827; }
    .btn.secondary:hover { background:#e5e7eb; }

    .history-list { display:flex; flex-direction:column; gap:16px; margin-top:8px; }
    .history-card { background:#fff; border-radius:16px; padding:16px; box-shadow: var(--shadow); border:1px solid #e5e7eb; }
    .history-title { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .history-item { border:1px solid #e5e7eb; border-radius:12px; padding:12px; }
    .history-head { display:flex; justify-content:space-between; align-items:center; color:#374151; font-size:13px; margin-bottom:6px; }
    .history-values { display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; font-size:14px; }
    @media (max-width:600px) { .history-values { grid-template-columns: 1fr; } }

    .badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:700; margin-left:6px; }
    .badge-blue { color: var(--blue); background: var(--blue-bg); }
    .badge-orange { color: var(--orange); background: var(--orange-bg); }
    .badge-red { color: var(--red); background: var(--red-bg); }

    .input-inline { flex:1; padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; background:#fff; }
  </style>
</head>
<body>
  <!-- Botão flutuante -->
  <button class="menu-btn" id="menuBtn" aria-label="Abrir menu"><i class="fa-solid fa-bars"></i></button>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar" aria-label="Menu">
    <h3>
      <span><i class="fa-solid fa-table-columns"></i> Painel</span>
      <span style="display:flex; gap:8px;">
        <button class="btn secondary" id="btnTrocarSenha" style="padding:6px 10px; font-size:12px;"><i class="fa-solid fa-key"></i> Trocar senha</button>
        <button class="btn secondary" id="btnLogout" style="padding:6px 10px; font-size:12px;"><i class="fa-solid fa-right-from-bracket"></i> Sair</button>
      </span>
    </h3>
    <a href="#" class="nav-link active" data-tab="tab-dados"><i class="fa-solid fa-user"></i> Pacientes</a>
    <a href="#" class="nav-link" data-tab="tab-exames"><i class="fa-solid fa-vial"></i> Exames</a>
    <a href="#" class="nav-link" data-tab="tab-historico"><i class="fa-solid fa-clock-rotate-left"></i> Histórico</a>
  </aside>

  <!-- Main -->
  <main class="container" id="appRoot" style="display:none;">
    <div class="header">
      <div class="title-card">
        <h1><i class="fa-solid fa-heart-pulse"></i> Painel de Saúde do Kaka </h1>
        <div class="title-actions">
          <button class="btn secondary" id="btnTrocarSenhaTop"><i class="fa-solid fa-key"></i> Trocar senha</button>
          <button class="btn secondary" id="btnLogoutTop"><i class="fa-solid fa-right-from-bracket"></i> Sair</button>
        </div>
      </div>
      <div class="patient-card" id="patientCard">
        <h2 id="patientName"><i class="fa-solid fa-user"></i> Paciente</h2>
        <p id="patientAge"><i class="fa-solid fa-cake-candles"></i> Idade: --</p>
      </div>
    </div>

    <section class="card">
      <!-- Aba: Pacientes -->
      <div id="tab-dados" class="tab active">
        <form id="formDados">
          <input type="hidden" id="pacienteId" />
          <div class="grid">
            <div>
              <label for="nome"><i class="fa-solid fa-user"></i> Nome completo</label>
              <input id="nome" type="text" placeholder="Seu nome" />
            </div>
            <div>
              <label for="nascimento"><i class="fa-solid fa-cake-candles"></i> Data de nascimento</label>
              <input id="nascimento" type="text" maxlength="10" placeholder="dd/mm/aaaa" />
            </div>
            <div>
              <label for="endereco"><i class="fa-solid fa-house"></i> Endereço</label>
              <input id="endereco" type="text" placeholder="Rua, número, bairro" />
            </div>
            <div>
              <label for="telefone"><i class="fa-solid fa-phone"></i> Telefone</label>
              <input id="telefone" type="tel" placeholder="(xx) xxxxx-xxxx" />
            </div>
            <div>
              <label for="sangue"><i class="fa-solid fa-droplet"></i> Tipo sanguíneo</label>
              <select id="sangue">
                <option value="">Selecione</option>
                <option>A+</option><option>A-</option>
                <option>B+</option><option>B-</option>
                <option>AB+</option><option>AB-</option>
                <option>O+</option><option>O-</option>
              </select>
            </div>
          </div>
          <div class="actions">
            <button class="btn primary" type="submit"><i class="fa-solid fa-floppy-disk"></i> Salvar paciente</button>
            <button class="btn secondary" type="button" id="limparDados"><i class="fa-solid fa-eraser"></i> Limpar</button>
          </div>
        </form>

        <div class="card" style="margin-top:16px;">
          <h3><i class="fa-solid fa-users"></i> Pacientes cadastrados</h3>
          <div id="listaPacientes" class="history-list"></div>
        </div>
      </div>

      <!-- Aba: Exames -->
      <div id="tab-exames" class="tab">
        <form id="formExames">
          <input type="hidden" id="exameId" />
          <div class="grid">
            <div>
              <label for="pacienteSelect"><i class="fa-solid fa-user-check"></i> Paciente</label>
              <select id="pacienteSelect"></select>
            </div>
            <div>
              <label for="glicemia"><i class="fa-solid fa-syringe"></i> Glicemia (mg/dL)</label>
              <input id="glicemia" type="number" min="0" step="1" placeholder="Ex: 95" />
            </div>
            <div>
              <label for="colesterol"><i class="fa-solid fa-heart-pulse"></i> Colesterol total (mg/dL)</label>
              <input id="colesterol" type="number" min="0" step="1" placeholder="Ex: 180" />
            </div>
            <div>
              <label for="trigliceridios"><i class="fa-solid fa-vial"></i> Triglicerídeos (mg/dL)</label>
              <input id="trigliceridios" type="number" min="0" step="1" placeholder="Ex: 150" />
            </div>
            <div>
              <label for="pressao"><i class="fa-solid fa-stethoscope"></i> Pressão arterial</label>
              <input id="pressao" type="text" maxlength="7" placeholder="Ex: 120/80" />
            </div>
            <div>
              <label for="bpm"><i class="fa-solid fa-heart"></i> BPM (batimentos por minuto)</label>
              <input id="bpm" type="number" min="0" step="1" placeholder="Ex: 72" />
            </div>
          </div>
          <div class="actions">
            <button class="btn primary" type="submit"><i class="fa-solid fa-floppy-disk"></i> Salvar exame</button>
            <button class="btn secondary" type="button" id="limparExame"><i class="fa-solid fa-eraser"></i> Limpar</button>
          </div>
        </form>
      </div>

      <!-- Aba: Histórico -->
      <div id="tab-historico" class="tab">
        <div class="actions" style="margin-bottom:8px;">
          <input type="text" id="buscaHistorico" class="input-inline"
                 placeholder="Filtrar por nome, data ou valor (ex: Maria, 120/80)" />
          <button class="btn secondary" type="button" id="ordenarRecente"><i class="fa-solid fa-arrow-down-wide-short"></i> Mais recentes</button>
          <button class="btn secondary" type="button" id="ordenarAntigo"><i class="fa-solid fa-arrow-up-short-wide"></i> Mais antigos</button>
          <button class="btn secondary" type="button" id="salvarPDF"><i class="fa-solid fa-file-pdf"></i> Exportar PDF</button>
          <button class="btn secondary" type="button" id="apagarHistorico"><i class="fa-solid fa-trash"></i> Apagar todo histórico</button>
        </div>
        <div id="listaHistorico" class="history-list"></div>
      </div>
    </section>
  </main>

  <script>
    // Constantes e estado
    const KEY_PAC = "pacientes_enc";
    const KEY_EXA = "exames_enc";
    const KEY_PASS = "painelSenha";
    let SECRET = "";     // senha usada como chave de criptografia
    let ordem = "desc";  // ordenação do histórico

    // Criptografia AES (CryptoJS)
    function encSave(key, obj) {
      try {
        const text = JSON.stringify(obj);
        const cipher = CryptoJS.AES.encrypt(text, SECRET).toString();
        localStorage.setItem(key, cipher);
      } catch (e) { console.error("Erro ao salvar:", e); }
    }
    function encLoad(key, fallback) {
      try {
        const cipher = localStorage.getItem(key);
        if (!cipher) return fallback;
        const bytes = CryptoJS.AES.decrypt(cipher, SECRET);
        const text = bytes.toString(CryptoJS.enc.Utf8);
        if (!text) return fallback;
        return JSON.parse(text);
      } catch (e) { console.warn("Erro ao carregar/decifrar:", e); return fallback; }
    }

    // Autenticação
    async function ensurePassword() {
      let senhaSalva = localStorage.getItem(KEY_PASS);

      if (!senhaSalva) {
        const { value: novaSenha } = await Swal.fire({
          title: "Crie uma senha",
          input: "password",
          inputLabel: "Essa senha protegerá seus dados locais",
          inputPlaceholder: "Digite uma senha",
          inputAttributes: { autocapitalize: "off", autocorrect: "off" },
          confirmButtonText: "Salvar",
          allowOutsideClick: false,
          allowEscapeKey: false
        });
        if (!novaSenha) {
          await Swal.fire({ icon: "error", title: "Senha obrigatória", text: "Recarregue e crie uma senha." });
          return false;
        }
        localStorage.setItem(KEY_PASS, novaSenha);
        senhaSalva = novaSenha;
      }

      const { value: tentativa } = await Swal.fire({
        title: "Digite a senha",
        input: "password",
        inputPlaceholder: "Sua senha",
        inputAttributes: { autocapitalize: "off", autocorrect: "off" },
        confirmButtonText: "Entrar",
        allowOutsideClick: false,
        allowEscapeKey: false
      });
      if (tentativa !== senhaSalva) {
        document.body.innerHTML = "<h2 style='font-family:Arial; text-align:center; margin-top:40px;'>Acesso bloqueado</h2>";
        await Swal.fire({ icon: "error", title: "Senha incorreta", text: "Recarregue a página e tente novamente." });
        return false;
      }

      SECRET = senhaSalva; // define a chave de criptografia
      document.getElementById("appRoot").style.display = "block";
      return true;
    }

    // Trocar senha (valida atual, define nova, recriptografa dados)
    async function trocarSenha() {
      const senhaSalva = localStorage.getItem(KEY_PASS);
      if (!senhaSalva) {
        await Swal.fire({ icon:"error", title:"Nenhuma senha configurada", text:"Recarregue a página para criar uma." });
        return;
      }
      const { value: atual } = await Swal.fire({
        title: "Senha atual",
        input: "password",
        inputPlaceholder: "Digite sua senha atual",
        confirmButtonText: "Continuar",
        showCancelButton: true
      });
      if (!atual) return;
      if (atual !== senhaSalva) { await Swal.fire({ icon:"error", title:"Senha incorreta" }); return; }

      const { value: nova } = await Swal.fire({
        title: "Nova senha",
        input: "password",
        inputPlaceholder: "Digite a nova senha",
        confirmButtonText: "Salvar",
        showCancelButton: true
      });
      if (!nova) return;

      // Carrega dados com SECRET atual
      SECRET = atual;
      const pacs = encLoad(KEY_PAC, []);
      const exas = encLoad(KEY_EXA, []);

      // Atualiza senha e recriptografa
      localStorage.setItem(KEY_PASS, nova);
      SECRET = nova;
      encSave(KEY_PAC, pacs);
      encSave(KEY_EXA, exas);

      await Swal.fire({ icon:"success", title:"Senha alterada com sucesso!" });
    }
    document.getElementById("btnTrocarSenha").addEventListener("click", trocarSenha);
    document.getElementById("btnTrocarSenhaTop").addEventListener("click", trocarSenha);

    // Logout (sem overlay, apenas pede senha novamente)
    async function logout() {
      const confirm = await Swal.fire({
        title:"Sair do painel?",
        text:"Você precisará digitar a senha novamente para acessar.",
        icon:"question", showCancelButton:true, confirmButtonText:"Sair", cancelButtonText:"Cancelar"
      });
      if (!confirm.isConfirmed) return;
      document.getElementById("appRoot").style.display = "none";
      SECRET = "";
      await ensurePassword();
      // Após reautenticar, não alterar abas — mantém fluxo
    }
    document.getElementById("btnLogout").addEventListener("click", logout);
    document.getElementById("btnLogoutTop").addEventListener("click", logout);

    // Sidebar e tabs
    document.getElementById("menuBtn").onclick = ()=> document.getElementById("sidebar").classList.toggle("active");
    document.querySelectorAll(".nav-link").forEach(link => {
      link.addEventListener("click", (e) => {
        e.preventDefault();
        const tabId = link.getAttribute("data-tab");
        setActiveTab(tabId);
        document.getElementById("sidebar").classList.remove("active");
      });
    });
    function setActiveTab(id) {
      document.querySelectorAll('.tab').forEach(t => { t.classList.remove('active'); t.style.display='none'; });
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      const tab = document.getElementById(id);
      if (tab) { tab.classList.add('active'); tab.style.display='block'; }
      document.querySelectorAll('.nav-link').forEach(l => { if (l.getAttribute('data-tab') === id) l.classList.add('active'); });
      if (id === "tab-exames") carregarPacientesSelect();
      if (id === "tab-historico") carregarHistorico();
    }

    // Utilitários
    function calcularIdadeDDMMAAAA(strData) {
      if (!strData || strData.length !== 10) return "";
      const [dia, mes, ano] = strData.split("/").map(Number);
      const nasc = new Date(ano, (mes - 1), dia);
      if (isNaN(nasc)) return "";
      const hoje = new Date();
      let idade = hoje.getFullYear() - nasc.getFullYear();
      const m = hoje.getMonth() - nasc.getMonth();
      if (m < 0 || (m === 0 && hoje.getDate() < nasc.getDate())) idade--;
      return idade;
    }
    document.getElementById("nascimento").addEventListener("input", (e) => {
      let v = e.target.value.replace(/\D/g, "");
      if (v.length > 2 && v.length <= 4) v = v.replace(/(\d{2})(\d+)/, "$1/$2");
      else if (v.length > 4) v = v.replace(/(\d{2})(\d{2})(\d+)/, "$1/$2/$3");
      e.target.value = v;
      const idade = calcularIdadeDDMMAAAA(e.target.value);
      document.getElementById("patientAge").innerHTML = `<i class="fa-solid fa-cake-candles"></i> ${idade !== "" ? `Idade: ${idade} anos` : "Idade: --"}`;
    });
    document.getElementById("pressao").addEventListener("input", (e) => {
      let v = e.target.value.replace(/\D/g, "");
      if (v.length > 3) v = v.replace(/(\d{2,3})(\d{1,3})/, "$1/$2");
      e.target.value = v;
    });
    function validarPressao(str) {
      if (!str) return true;
      return /^\s*\d{2,3}\s*\/\s*\d{1,3}\s*$/.test(str);
    }

    // Badges
    function avaliarGlicemia(v) { const n = Number(v); if (!v && v !== 0) return { cls:"", msg:"" }; if (n < 60) return { cls:"badge-orange", msg:"Baixo" }; if (n <= 120) return { cls:"badge-blue", msg:"Normal" }; return { cls:"badge-red", msg:"Alto" }; }
    function avaliarColesterol(v) { const n = Number(v); if (!v && v !== 0) return { cls:"", msg:"" }; if (n < 200) return { cls:"badge-blue", msg:"Desejável" }; if (n < 240) return { cls:"badge-orange", msg:"Limítrofe" }; return { cls:"badge-red", msg:"Alto" }; }
    function avaliarTrigliceridios(v) { const n = Number(v); if (!v && v !== 0) return { cls:"", msg:"" }; if (n < 150) return { cls:"badge-blue", msg:"Normal" }; if (n < 200) return { cls:"badge-orange", msg:"Limítrofe" }; return { cls:"badge-red", msg:"Alto" }; }
    function avaliarBPM(v) { const n = Number(v); if (!v && v !== 0) return { cls:"", msg:"" }; if (n < 60) return { cls:"badge-orange", msg:"Baixo" }; if (n <= 100) return { cls:"badge-blue", msg:"Normal" }; return { cls:"badge-red", msg:"Alto" }; }
    function avaliarPressao(val) { if (!val || !val.includes("/")) return { cls:"", msg:"" }; const [s, d] = val.split("/").map(v => parseInt(v, 10)); if (isNaN(s) || isNaN(d)) return { cls:"", msg:"" }; if (s < 90 || d < 60) return { cls:"badge-orange", msg:"Baixa" }; if (s <= 139 && d <= 89) return { cls:"badge-blue", msg:"Normal" }; return { cls:"badge-red", msg:"Alta" }; }

    // Pacientes
    const formDados = document.getElementById("formDados");
    const limparDadosBtn = document.getElementById("limparDados");
    const listaPacientes = document.getElementById("listaPacientes");

    formDados.addEventListener("submit", (e) => {
      e.preventDefault();
      const idInput = document.getElementById("pacienteId");
      const nome = document.getElementById("nome").value.trim();
      if (!nome) { Swal.fire({ icon:'error', title:'Informe o nome do paciente.' }); return; }
      const paciente = {
        id: idInput.value ? Number(idInput.value) : Date.now(),
        nome,
        nascimento: document.getElementById("nascimento").value.trim(),
        endereco: document.getElementById("endereco").value.trim(),
        telefone: document.getElementById("telefone").value.trim(),
        sangue: document.getElementById("sangue").value
      };
      let pacs = encLoad(KEY_PAC, []);
      const idx = pacs.findIndex(p => p.id === paciente.id);
      if (idx >= 0) pacs[idx] = paciente; else pacs.push(paciente);
      encSave(KEY_PAC, pacs);
      Swal.fire({ icon:'success', title: idx>=0 ? 'Paciente atualizado!' : 'Paciente salvo!', timer:1400, showConfirmButton:false });
      formDados.reset(); document.getElementById("pacienteId").value = "";
      atualizarHeaderPaciente(null);
      renderListaPacientes();
      carregarPacientesSelect();
    });

    limparDadosBtn.addEventListener("click", () => {
      formDados.reset(); document.getElementById("pacienteId").value = "";
      atualizarHeaderPaciente(null);
    });

    function renderListaPacientes() {
      const pacs = encLoad(KEY_PAC, []);
      listaPacientes.innerHTML = "";
      if (pacs.length === 0) {
        const vazio = document.createElement("div");
        vazio.className = "history-item";
        vazio.innerHTML = `<i class="fa-regular fa-folder-open"></i> Nenhum paciente cadastrado.`;
        listaPacientes.appendChild(vazio);
        return;
      }
      pacs.forEach(p => {
        const item = document.createElement("div");
        item.className = "history-item";
        item.innerHTML = `
          <div class="history-head">
            <span><i class="fa-solid fa-user"></i> ${p.nome}</span>
            <span class="badge badge-blue">${p.sangue || "--"}</span>
          </div>
          <div class="history-values">
            <span><strong><i class="fa-solid fa-cake-candles"></i> Nasc.:</strong> ${p.nascimento || "--"}</span>
            <span><strong><i class="fa-solid fa-phone"></i> Tel.:</strong> ${p.telefone || "--"}</span>
            <span><strong><i class="fa-solid fa-house"></i> End.:</strong> ${p.endereco || "--"}</span>
          </div>
          <div class="actions">
            <button class="btn secondary" aria-label="Selecionar"><i class="fa-solid fa-check"></i> Selecionar</button>
            <button class="btn secondary" aria-label="Editar"><i class="fa-solid fa-pen"></i> Editar</button>
            <button class="btn secondary" aria-label="Remover"><i class="fa-solid fa-trash"></i> Remover</button>
          </div>
        `;
        const [btnSel, btnEdit, btnDel] = item.querySelectorAll(".actions .btn.secondary");
        btnSel.addEventListener("click", () => {
          setActiveTab("tab-exames");
          carregarPacientesSelect(p.id);
        });
        btnEdit.addEventListener("click", () => {
          setActiveTab("tab-dados");
          document.getElementById("pacienteId").value = p.id;
          document.getElementById("nome").value = p.nome || "";
          document.getElementById("nascimento").value = p.nascimento || "";
          document.getElementById("endereco").value = p.endereco || "";
          document.getElementById("telefone").value = p.telefone || "";
          document.getElementById("sangue").value = p.sangue || "";
          atualizarHeaderPaciente(p);
        });
        btnDel.addEventListener("click", () => {
          Swal.fire({
            title: 'Remover paciente?',
            text: 'Exames associados NÃO serão apagados automaticamente.',
            icon: 'warning', showCancelButton:true, confirmButtonText:'Remover', cancelButtonText:'Cancelar'
          }).then(res => {
            if (res.isConfirmed) {
              const novos = pacs.filter(pp => pp.id !== p.id);
              encSave(KEY_PAC, novos);
              renderListaPacientes();
              carregarPacientesSelect();
              Swal.fire('Removido!', 'Paciente excluído.', 'success');
            }
          });
        });
        listaPacientes.appendChild(item);
      });
    }

    function atualizarHeaderPaciente(p) {
      const nameEl = document.getElementById("patientName");
      const ageEl = document.getElementById("patientAge");
      if (p) {
        nameEl.innerHTML = `<i class="fa-solid fa-user"></i> ${p.nome}`;
        const idade = calcularIdadeDDMMAAAA(p.nascimento);
        ageEl.innerHTML = `<i class="fa-solid fa-cake-candles"></i> ${idade !== "" ? `Idade: ${idade} anos` : "Idade: --"}`;
      } else {
        nameEl.innerHTML = `<i class="fa-solid fa-user"></i> Paciente`;
        ageEl.innerHTML = `<i class="fa-solid fa-cake-candles"></i> Idade: --`;
      }
    }

    // Exames
    const formExames = document.getElementById("formExames");
    const limparExameBtn = document.getElementById("limparExame");
    const pacienteSelect = document.getElementById("pacienteSelect");

    function carregarPacientesSelect(preselectId=null) {
      const pacs = encLoad(KEY_PAC, []);
      pacienteSelect.innerHTML = "";
      if (pacs.length === 0) {
        const opt = document.createElement("option");
        opt.value = ""; opt.textContent = "Cadastre um paciente primeiro";
        pacienteSelect.appendChild(opt);
        return;
      }
      pacs.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id; opt.textContent = p.nome;
        pacienteSelect.appendChild(opt);
      });
      if (preselectId) pacienteSelect.value = preselectId;
      const current = pacs.find(pp => pp.id === Number(pacienteSelect.value));
      atualizarHeaderPaciente(current || null);
      const exaId = document.getElementById("exameId").value;
      if (!exaId) formExames.reset();
    }

    pacienteSelect.addEventListener("change", () => {
      const pacs = encLoad(KEY_PAC, []);
      const current = pacs.find(pp => pp.id === Number(pacienteSelect.value));
      atualizarHeaderPaciente(current || null);
    });

    formExames.addEventListener("submit", (e) => {
      e.preventDefault();
      const pid = Number(pacienteSelect.value);
      if (!pid) { Swal.fire({ icon:'error', title:'Selecione um paciente.' }); return; }
      const pressao = document.getElementById("pressao").value.trim();
      if (!validarPressao(pressao)) { Swal.fire({ icon:'error', title:'Formato inválido', text:'Pressão deve ser algo como 120/80.' }); return; }

      const exas = encLoad(KEY_EXA, []);
      const editIdVal = document.getElementById("exameId").value;
      const original = editIdVal ? exas.find(x => x.id === Number(editIdVal)) : null;

      const exame = {
        id: editIdVal ? Number(editIdVal) : Date.now(),
        pacienteId: pid,
        dataISO: original?.dataISO || new Date().toISOString(),
        glicemia: document.getElementById("glicemia").value.trim() || "",
        colesterol: document.getElementById("colesterol").value.trim() || "",
        trigliceridios: document.getElementById("trigliceridios").value.trim() || "",
        pressao: pressao || "",
        bpm: document.getElementById("bpm").value.trim() || ""
      };

      const idx = exas.findIndex(e => e.id === exame.id);
      if (idx >= 0) exas[idx] = exame; else exas.push(exame);
      encSave(KEY_EXA, exas);

      document.getElementById("exameId").value = "";
      formExames.reset();
      Swal.fire({ icon:'success', title: idx>=0 ? 'Exame atualizado!' : 'Exame salvo!', timer:1400, showConfirmButton:false });
      setActiveTab("tab-historico");
      carregarHistorico();
    });

    limparExameBtn.addEventListener("click", () => {
      document.getElementById("exameId").value = "";
      formExames.reset();
    });

    // Histórico
    const buscaHistorico = document.getElementById("buscaHistorico");
    const listaHistorico = document.getElementById("listaHistorico");
    document.getElementById("ordenarRecente").addEventListener("click", () => { ordem = "desc"; carregarHistorico(); });
    document.getElementById("ordenarAntigo").addEventListener("click", () => { ordem = "asc"; carregarHistorico(); });
    buscaHistorico.addEventListener("input", carregarHistorico);

    function carregarHistorico() {
      const pacs = encLoad(KEY_PAC, []);
      let exas = encLoad(KEY_EXA, []);

      exas.sort((a, b) => ordem === "desc" ? new Date(b.dataISO) - new Date(a.dataISO) : new Date(a.dataISO) - new Date(b.dataISO));

      const termo = (buscaHistorico.value || "").toLowerCase().trim();
      if (termo) {
        exas = exas.filter(ex => {
          const p = pacs.find(pp => pp.id === ex.pacienteId);
          const nome = (p ? p.nome : "").toLowerCase();
          const dataFmt = new Date(ex.dataISO).toLocaleString("pt-BR", { dateStyle: "short", timeStyle: "short" }).toLowerCase();
          return (
            nome.includes(termo) || dataFmt.includes(termo) ||
            String(ex.glicemia).toLowerCase().includes(termo) ||
            String(ex.colesterol).toLowerCase().includes(termo) ||
            String(ex.trigliceridios).toLowerCase().includes(termo) ||
            String(ex.pressao).toLowerCase().includes(termo) ||
            String(ex.bpm).toLowerCase().includes(termo)
          );
        });
      }

      const grupo = {};
      exas.forEach(ex => { if (!grupo[ex.pacienteId]) grupo[ex.pacienteId] = []; grupo[ex.pacienteId].push(ex); });

      listaHistorico.innerHTML = "";

      const ids = Object.keys(grupo);
      if (ids.length === 0) {
        const vazio = document.createElement("div");
        vazio.className = "history-item";
        vazio.innerHTML = `<i class="fa-regular fa-folder-open"></i> Nenhum exame encontrado.`;
        listaHistorico.appendChild(vazio);
        return;
      }

      ids.forEach(pidStr => {
        const pid = Number(pidStr);
        const p = pacs.find(pp => pp.id === pid);

        const card = document.createElement("div");
        card.className = "history-card";

        const title = document.createElement("div");
        title.className = "history-title";
        title.innerHTML = `
          <h3><i class="fa-solid fa-user"></i> ${p ? p.nome : "Paciente removido"} ${p && p.sangue ? `<span class="badge badge-blue">${p.sangue}</span>` : ""}</h3>
          <span><i class="fa-solid fa-cake-candles"></i> ${p && p.nascimento ? p.nascimento : "--"}</span>
        `;
        card.appendChild(title);

        grupo[pid].forEach(exame => {
          const dataFmt = new Date(exame.dataISO).toLocaleString("pt-BR", { dateStyle: "short", timeStyle: "short" });
          const g = avaliarGlicemia(exame.glicemia);
          const c = avaliarColesterol(exame.colesterol);
          const t = avaliarTrigliceridios(exame.trigliceridios);
          const pr = avaliarPressao(exame.pressao);
          const b = avaliarBPM(exame.bpm);

          const item = document.createElement("div");
          item.className = "history-item";

          const head = document.createElement("div");
          head.className = "history-head";
          head.innerHTML = `
            <span><i class="fa-solid fa-calendar-day"></i> ${dataFmt}</span>
            <span class="badge badge-blue"><i class="fa-solid fa-vial"></i> Exame</span>
          `;

          const values = document.createElement("div");
          values.className = "history-values";
          values.innerHTML = `
            <div><strong><i class="fa-solid fa-user"></i> Paciente:</strong> ${p ? p.nome : "--"}</div>
            <div><strong><i class="fa-solid fa-syringe"></i> Glicemia:</strong> ${exame.glicemia || "--"} ${g.msg ? `<span class="badge ${g.cls}">${g.msg}</span>` : ""}</div>
            <div><strong><i class="fa-solid fa-heart-pulse"></i> Colesterol:</strong> ${exame.colesterol || "--"} ${c.msg ? `<span class="badge ${c.cls}">${c.msg}</span>` : ""}</div>
            <div><strong><i class="fa-solid fa-vial"></i> Triglicerídeos:</strong> ${exame.trigliceridios || "--"} ${t.msg ? `<span class="badge ${t.cls}">${t.msg}</span>` : ""}</div>
            <div><strong><i class="fa-solid fa-stethoscope"></i> Pressão:</strong> ${exame.pressao || "--"} ${pr.msg ? `<span class="badge ${pr.cls}">${pr.msg}</span>` : ""}</div>
            <div><strong><i class="fa-solid fa-heart"></i> BPM:</strong> ${exame.bpm || "--"} ${b.msg ? `<span class="badge ${b.cls}">${b.msg}</span>` : ""}</div>
          `;

          const actions = document.createElement("div");
          actions.className = "actions";
          const editarBtn = document.createElement("button");
          editarBtn.className = "btn secondary";
          editarBtn.innerHTML = `<i class="fa-solid fa-pen"></i> Editar`;
          editarBtn.addEventListener("click", () => editarExame(exame.id));

          const removerBtn = document.createElement("button");
          removerBtn.className = "btn secondary";
          removerBtn.innerHTML = `<i class="fa-solid fa-trash"></i> Remover`;
          removerBtn.addEventListener("click", () => {
            Swal.fire({
              title: 'Remover este exame?', text: "Essa ação não pode ser desfeita.",
              icon: 'warning', showCancelButton: true, confirmButtonText: 'Sim, remover', cancelButtonText: 'Cancelar'
            }).then((result) => {
              if (result.isConfirmed) {
                removerExame(exame.id);
                Swal.fire('Removido!', 'O exame foi excluído.', 'success');
              }
            });
          });

          actions.appendChild(editarBtn);
          actions.appendChild(removerBtn);
          item.appendChild(head);
          item.appendChild(values);
          item.appendChild(actions);
          card.appendChild(item);
        });

        listaHistorico.appendChild(card);
      });
    }

    function editarExame(exameId) {
      const exas = encLoad(KEY_EXA, []);
      const ex = exas.find(e => e.id === exameId);
      if (!ex) return;
      setActiveTab("tab-exames");
      document.getElementById("exameId").value = ex.id;
      carregarPacientesSelect(ex.pacienteId);
      document.getElementById("glicemia").value = ex.glicemia || "";
      document.getElementById("colesterol").value = ex.colesterol || "";
      document.getElementById("trigliceridios").value = ex.trigliceridios || "";
      document.getElementById("pressao").value = ex.pressao || "";
      document.getElementById("bpm").value = ex.bpm || "";
    }

    function removerExame(id) {
      const exas = encLoad(KEY_EXA, []);
      const novos = exas.filter(e => e.id !== id);
      encSave(KEY_EXA, novos);
      carregarHistorico();
    }

    // Apagar todo histórico (exames)
    document.getElementById("apagarHistorico").addEventListener("click", () => {
      Swal.fire({
        title: "Apagar todo histórico?",
        text: "Isso removerá todos os exames de todos os pacientes.",
        icon: "warning", showCancelButton: true, confirmButtonText: "Sim, apagar", cancelButtonText: "Cancelar"
      }).then(res => {
        if (res.isConfirmed) {
          localStorage.removeItem(KEY_EXA); // remove cifrado
          carregarHistorico();
          Swal.fire("Apagado!", "Todo o histórico foi removido.", "success");
        }
      });
    });

    // PDF (pacientes + exames) com dados decifrados
    document.getElementById("salvarPDF").addEventListener("click", () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const pacs = encLoad(KEY_PAC, []);
      let exas = encLoad(KEY_EXA, []);
      exas.sort((a, b) => new Date(b.dataISO) - new Date(a.dataISO));

      doc.setFontSize(18);
      doc.text("Relatório de Saúde", 14, 20);
      doc.setFontSize(11);
      doc.text("Gerado em: " + new Date().toLocaleString("pt-BR"), 14, 28);

      let y = 36;

      // Pacientes
      doc.setFontSize(13); doc.text("Pacientes cadastrados", 14, y); y += 8; doc.setFontSize(11);
      if (pacs.length === 0) { doc.text("Nenhum paciente.", 14, y); y += 10; }
      else {
        pacs.forEach((p, i) => {
          doc.text(`${i+1}. ${p.nome || "--"} | Nasc.: ${p.nascimento || "--"} | Tel.: ${p.telefone || "--"} | Sangue: ${p.sangue || "--"}`, 14, y);
          y += 6; if (y > 270) { doc.addPage(); y = 20; }
        });
        y += 4;
      }

      // Exames por paciente
      doc.setFontSize(13); doc.text("Exames por paciente", 14, y); y += 8; doc.setFontSize(11);
      if (exas.length === 0) { doc.text("Nenhum exame registrado.", 14, y); }
      else {
        const grupo = {}; exas.forEach(ex => { if (!grupo[ex.pacienteId]) grupo[ex.pacienteId] = []; grupo[ex.pacienteId].push(ex); });
        Object.keys(grupo).forEach(pidStr => {
          const pid = Number(pidStr);
          const p = pacs.find(pp => pp.id === pid);
          doc.text(`Paciente: ${p ? p.nome : "Paciente removido"} (${p && p.sangue ? p.sangue : "--"})`, 14, y); y += 6;
          grupo[pid].forEach((ex, idx) => {
            const dataFmt = new Date(ex.dataISO).toLocaleString("pt-BR");
            doc.text(`  ${idx+1}. ${dataFmt}`, 14, y); y += 6;
            doc.text(`     Glicemia: ${ex.glicemia || "--"} | Colesterol: ${ex.colesterol || "--"} | Triglicerídeos: ${ex.trigliceridios || "--"}`, 14, y); y += 6;
            doc.text(`     Pressão: ${ex.pressao || "--"} | BPM: ${ex.bpm || "--"}`, 14, y); y += 8;
            if (y > 270) { doc.addPage(); y = 20; }
          });
          y += 4; if (y > 270) { doc.addPage(); y = 20; }
        });
      }

      doc.save("relatorio-saude.pdf");
      Swal.fire({ icon: 'success', title: 'PDF gerado!', text: 'Relatório salvo com sucesso.', timer: 1600, showConfirmButton: false });
    });

    // Inicialização protegida
    window.addEventListener("DOMContentLoaded", async () => {
      const ok = await ensurePassword();
      if (!ok) return;
      setActiveTab("tab-dados");
      renderListaPacientes();
      carregarPacientesSelect();
      carregarHistorico();
    });
  </script>
</body>
</html>