<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Mapa de Press√£o Arterial</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root{
      --primary:#1565c0;
      --primary-dark:#0d47a1;
      --blue:#1565c0;
      --yellow:#f1c40f;
      --red:#e74c3c;
      --shadow:0 6px 20px rgba(0,0,0,0.1);
    }
    *{box-sizing:border-box}
    body{
      font-family:'Segoe UI', Tahoma, sans-serif;
      background:linear-gradient(135deg,#e3f2fd,#f9f9f9);
      margin:0; padding:16px; color:#333;
      text-align: center;
    }
    h1{
      text-align:center; color:white; margin:0 0 12px;
      display:flex; align-items:center; justify-content:center; gap:10px; flex-wrap:wrap;background-color: #0060df;
      padding: 5px; border-radius: 10px;
    }
    .container{
      max-width:960px; margin:auto; background:#fff; padding:16px;
      border-radius:12px; box-shadow:var(--shadow);
    }
    /* Card do paciente */
    .card-paciente{
      margin:0 auto 20px auto;
      width:100%; max-width:520px;
      background:#fff; border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.12);
      padding:16px; border:1px solid #eef2f7; text-align:center;
    }
    .card-paciente h3{
      margin:0 0 8px; color:var(--primary);
      display:flex; align-items:center; justify-content:center; gap:8px;
    }
    .card-body{color:#444; display:flex; flex-direction:column; gap:6px;}
    .card-actions{display:flex; gap:8px; justify-content:center; margin-top:10px;}
    .btn{
      display:inline-flex; align-items:center; gap:6px;
      padding:10px 14px; border:none; border-radius:8px; cursor:pointer;
      font-weight:600; color:#fff; background:var(--primary);
    }
    .btn:hover{background:var(--primary-dark);}
    .btn.edit{background:#f39c12;}
    .btn.delete{background:var(--red);}

    /* Formul√°rio responsivo (somente press√£o e data) */
    .grid{display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin-bottom:16px;}
    @media(max-width:768px){ .grid{ grid-template-columns:1fr; } }
    .field{display:flex; flex-direction:column; gap:6px;}
    label{font-weight:600; font-size:14px;}
    input{
      padding:10px; border-radius:8px; border:1px solid #ccc; font-size:15px;
      transition:border-color .2s, box-shadow .2s; text-align: center;
    }
    input:focus{ outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(21,101,192,0.12); }

    /* Tabela */
    .table-wrap{ overflow-x:auto; }
    table{width:100%; border-collapse:collapse; font-size:15px;}
    th,td{border:1px solid #ddd; padding:6px 8px; text-align:center;}
    th{background:var(--primary); color:#fff;}
    tr:nth-child(even){background:#f5f8fe;}
    .pressao.normal{color:var(--blue); font-weight:bold;}
    .pressao.medio{color:var(--yellow); font-weight:bold;}
    .pressao.alto{color:var(--red); font-weight:bold;}

    /* Bot√£o flutuante */
    .fab{
      position:fixed; bottom:20px; right:20px;
      width:56px; height:56px; border-radius:50%;
      background:var(--primary); color:#fff; border:none;
      display:flex; align-items:center; justify-content:center;
      font-size:24px; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.3); z-index:1200;
    }

    /* Menu lateral (drawer) */
    .sidebar{
      position:fixed; top:0; left:-280px; width:260px; height:100%;
      background:#fff; box-shadow:2px 0 12px rgba(0,0,0,0.2);
      padding:18px; transition:left 0.3s ease; z-index:1100;
      display:flex; flex-direction:column; gap:10px;
    }
    .sidebar.show{ left:0; }
    .sidebar h2{
      margin:4px 0 12px 0; color:var(--primary);
      display:flex; align-items:center; gap:8px;
    }
    .sidebar .btn{ width:100%; justify-content:flex-start; }
    .sidebar .save{background:var(--primary);}
    .sidebar .pdf{background:#607d8b;}
    .sidebar .clear{background:var(--red);}
    .sidebar .close{
      background:#999; align-self:flex-end; padding:6px 10px; border-radius:6px;
    }

    /* Overlay ao abrir menu */
    .overlay{
      position:fixed; inset:0; background:rgba(0,0,0,0.35);
      opacity:0; pointer-events:none; transition:opacity .2s; z-index:1050;
    }
    .overlay.show{ opacity:1; pointer-events:auto; }

    /* Footer */
    .footer{
      text-align: center;
      margin-top:30px;
      background: linear-gradient(135deg, #1565c0, #0d47a1);
      color:#fff;
      padding:20px 10px;
      border-radius:12px;
      box-shadow:0 -3px 10px rgba(0,0,0,0.2);
    }
    .footer-content p{ margin:6px 0; font-size:14px; }
  </style>
</head>
<body>
  <div class="container">
    <h1><i class="fa-solid fa-heart-pulse"></i> Mapeamento de Press√£o Arterial</h1>
    <br>
    <!-- Card do paciente -->
    <div id="cardPaciente" class="card-paciente">
      <h3><i class="fa-solid fa-id-card"></i> Paciente</h3>
      <div id="cardBody" class="card-body"><span style="color:#888">Nenhum paciente salvo.</span></div>
      <div class="card-actions">
        <button class="btn edit" id="btnEditarPaciente"><i class="fa-solid fa-pen"></i> Editar</button>
        <button class="btn delete" id="btnApagarPaciente"><i class="fa-solid fa-trash"></i> Apagar</button>
      </div>
    </div>

    <!-- Formul√°rio (somente press√£o e data) -->
    <div class="grid">
      <div class="field">
        <label for="pressao"><i class="fa-solid fa-heart"></i> Press√£o</label>
        <input id="pressao" type="text" placeholder="Ex.: 120/80" maxlength="7" required />
      </div>
      <div class="field">
        <label for="data"><i class="fa-solid fa-calendar-days"></i> Data</label>
        <input id="data" type="date" required />
      </div>
    </div>

    <div class="actions">
      <button class="btn" id="btnAdd"><i class="fa-solid fa-plus"></i> Adicionar registro</button>
    </div>
    <br>
    <!-- Tabela -->
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th><i class="fa-solid fa-heart"></i> Press√£o</th>
            <th><i class="fa-solid fa-calendar"></i> Data</th>
            <th><i class="fa-solid fa-gear"></i> A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="footer">
      <div class="footer-content">
        <p>üåê Site criado por: <strong>Carlos de Freitas Rocha (ACE)</strong></p>
        <p>üìÖ Criado em <span id="ano"></span> ‚Ä¢ üìç Itinga do Maranh√£o - MA, Brasil</p>
      </div>
    </div>
  </div>

  <!-- Bot√£o flutuante -->
  <button class="fab" id="fab" title="Abrir menu"><i class="fa-solid fa-bars"></i></button>

  <!-- Menu lateral -->
  <div class="sidebar" id="sidebar">
    <h2><i class="fa-solid fa-gear"></i> Menu</h2>
    <button class="btn save" id="btnSalvarPaciente"><i class="fa-solid fa-user-check"></i> Salvar paciente</button>
    <button class="btn pdf" id="btnPDF"><i class="fa-solid fa-file-pdf"></i> Exportar PDF</button>
    <button class="btn clear" id="btnClear"><i class="fa-solid fa-trash"></i> Apagar tabela</button>
    <button class="btn close" id="btnClose"><i class="fa-solid fa-xmark"></i> Fechar</button>
  </div>

  <!-- Overlay -->
  <div class="overlay" id="overlay"></div>

<script>
  // Estado
  let registros = JSON.parse(localStorage.getItem('registros_pressao')) || [];
  let paciente = JSON.parse(localStorage.getItem('paciente')) || null;
  let editIndex = null;

  // Refer√™ncias
  const tbody = document.getElementById('tbody');
  const cardBody = document.getElementById('cardBody');
  const fab = document.getElementById('fab');
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('overlay');

  // Utils
  function salvarRegistros(){ localStorage.setItem('registros_pressao', JSON.stringify(registros)); }
  function salvarPacienteLocal(){ localStorage.setItem('paciente', JSON.stringify(paciente)); }
  function formatarDataISOparaBR(iso){ if(!iso) return ''; const [a,m,d] = iso.split('-'); return `${d}/${m}/${a}`; }
  function formatarBRparaISO(br){ if(!br) return ''; const [d,m,a] = br.split('/'); return `${a}-${m}-${d}`; }
  function classificarPressao(valor){
    const [sis, dia] = valor.split('/').map(Number);
    if (sis < 130 && dia < 85) return 'normal';
    if ((sis >= 130 && sis <= 139) || (dia >= 85 && dia <= 89)) return 'medio';
    return 'alto';
  }
  function ordenarPorDataDesc(arr){
    return arr.slice().sort((a,b) => new Date(formatarBRparaISO(b.data)) - new Date(formatarBRparaISO(a.data)));
  }

  // Render tabela
  function renderTabela(){
    tbody.innerHTML = '';
    const lista = ordenarPorDataDesc(registros);
    lista.forEach((item, index) => {
      const classe = classificarPressao(item.pressao);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="pressao ${classe}">${item.pressao}</td>
        <td>${item.data}</td>
        <td>
          <button class="btn edit" title="Editar" onclick="editarRegistro(${index})">
            <i class="fa-solid fa-pen"></i>
          </button>
          <button class="btn delete" title="Apagar" onclick="apagarRegistro(${index})">
            <i class="fa-solid fa-trash"></i>
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Render card paciente
  function renderCardPaciente(){
    if (!paciente){
      cardBody.innerHTML = '<span style="color:#888">Nenhum paciente salvo.</span>';
      return;
    }
    cardBody.innerHTML = `
      <div><i class="fa-solid fa-user"></i> <strong>${paciente.nome}</strong></div>
      <div><i class="fa-solid fa-cake-candles"></i> ${paciente.idade} anos</div>
      <div><i class="fa-solid fa-droplet"></i> Tipo sangu√≠neo: ${paciente.tipo || '-'}</div>
    `;
  }

  // Popup SweetAlert para cadastrar/editar paciente com seletor
  async function abrirPopupPaciente(dados = {}){
    const { nome = '', idade = '', tipo = '' } = dados;
    const { value: formValues } = await Swal.fire({
      title: 'Dados do paciente',
      html: `
        <div style="text-align:left; display:grid; gap:10px;">
          <label><strong>Nome</strong><br/>
            <input id="swal_nome" class="swal2-input" placeholder="Ex.: Maria Souza"  style="width:90%" value="${nome}">
          </label>
          <label><strong>Idade</strong><br/>
            <input id="swal_idade" type="number" min="0" class="swal2-input" placeholder="Ex.: 54" style="width:90%" value="${idade}">
          </label>
          <label><strong>Tipo sangu√≠neo</strong><br/>
            <select id="swal_tipo" class="swal2-select" style="width:30%; padding:10px; border-radius:8px; border:1px solid #ccc;">
              <option value="">Selecione</option>
              <option value="A+" ${tipo==='A+'?'selected':''}>A+</option>
              <option value="A-" ${tipo==='A-'?'selected':''}>A-</option>
              <option value="B+" ${tipo==='B+'?'selected':''}>B+</option>
              <option value="B-" ${tipo==='B-'?'selected':''}>B-</option>
              <option value="AB+" ${tipo==='AB+'?'selected':''}>AB+</option>
              <option value="AB-" ${tipo==='AB-'?'selected':''}>AB-</option>
              <option value="O+" ${tipo==='O+'?'selected':''}>O+</option>
              <option value="O-" ${tipo==='O-'?'selected':''}>O-</option>
            </select>
          </label>
        </div>
      `,
      focusConfirm: false,
      showCancelButton: true,
      confirmButtonText: 'Salvar paciente',
      cancelButtonText: 'Cancelar',
      preConfirm: () => {
        const nome = document.getElementById('swal_nome').value.trim();
        const idade = document.getElementById('swal_idade').value.trim();
        const tipo = document.getElementById('swal_tipo').value;

        if (!nome || !idade){
          Swal.showValidationMessage('Informe nome e idade.');
          return false;
        }
        const iNum = Number(idade);
        if (isNaN(iNum) || iNum < 0 || iNum > 120){
          Swal.showValidationMessage('Idade inv√°lida. Use um valor entre 0 e 120.');
          return false;
        }
        return { nome, idade: iNum, tipo: tipo || '' };
      }
    });
    return formValues || null;
  }

  // Editar e apagar registro
  window.editarRegistro = function(index){
    const item = registros[index];
    document.getElementById('pressao').value = item.pressao;
    document.getElementById('data').value = formatarBRparaISO(item.data);
    editIndex = index;
    Swal.fire({ icon:'info', title:'Edi√ß√£o', text:'Voc√™ est√° editando este registro.' });
  }

  window.apagarRegistro = function(index){
    Swal.fire({
      title: 'Tem certeza?',
      text: 'Esse registro ser√° apagado.',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Sim, apagar',
      cancelButtonText: 'Cancelar'
    }).then(res => {
      if (res.isConfirmed){
        registros.splice(index,1);
        salvarRegistros();
        renderTabela();
        Swal.fire({ icon:'success', title:'Apagado', text:'Registro removido com sucesso.' });
      }
    });
  }

  // Adicionar/Atualizar registro
  document.getElementById('btnAdd').addEventListener('click', (e) => {
    e.preventDefault();
    const pressao = document.getElementById('pressao').value.trim();
    const dataISO = document.getElementById('data').value;

    if (!pressao || !dataISO){
      Swal.fire({ icon:'warning', title:'Campos obrigat√≥rios', text:'Informe press√£o e data.' });
      return;
    }
    if (!/^\d{2,3}\/\d{2}$/.test(pressao)){
      Swal.fire({ icon:'error', title:'Formato inv√°lido', text:'Use o formato 120/80.' });
      return;
    }
    // Limites razo√°veis
    const [sis, dia] = pressao.split('/').map(Number);
    if (sis < 50 || sis > 250 || dia < 30 || dia > 150){
      Swal.fire({ icon:'error', title:'Valores inv√°lidos', text:'Verifique os valores de sist√≥lica/diast√≥lica.' });
      return;
    }

    const novo = { pressao, data: formatarDataISOparaBR(dataISO) };
    if (editIndex === null){
      registros.push(novo);
      Swal.fire({ icon:'success', title:'Adicionado', text:'Registro salvo com sucesso.' });
    } else {
      registros[editIndex] = novo;
      editIndex = null;
      Swal.fire({ icon:'info', title:'Atualizado', text:'Registro atualizado.' });
    }
    salvarRegistros();
    renderTabela();
    document.getElementById('pressao').value = '';
    document.getElementById('data').value = '';
  });

  // Salvar paciente (menu lateral) -> abre popup e fecha menu
  document.getElementById('btnSalvarPaciente').addEventListener('click', async () => {
    fecharMenu(); // fechar imediatamente ap√≥s clique
    const valores = await abrirPopupPaciente(paciente || {});
    if (!valores) return;
    paciente = valores;
    salvarPacienteLocal();
    renderCardPaciente();
    Swal.fire({ icon:'success', title:'Paciente salvo', text:'Dados armazenados no dispositivo.' });
  });

  // Editar paciente a partir do card -> abre popup preenchido
  document.getElementById('btnEditarPaciente').addEventListener('click', async () => {
    if (!paciente){
      Swal.fire({ icon:'info', title:'Sem paciente', text:'Salve o paciente primeiro.' });
      return;
    }
    const valores = await abrirPopupPaciente(paciente);
    if (!valores) return;
    paciente = valores;
    salvarPacienteLocal();
    renderCardPaciente();
    Swal.fire({ icon:'success', title:'Paciente atualizado', text:'Dados atualizados com sucesso.' });
  });

  // Apagar paciente
  document.getElementById('btnApagarPaciente').addEventListener('click', () => {
    if (!paciente){
      Swal.fire({ icon:'info', title:'Sem paciente', text:'Nada para apagar.' });
      return;
    }
    Swal.fire({
      title:'Apagar paciente?',
      text:'Isso remover√° os dados do paciente salvo.',
      icon:'warning',
      showCancelButton:true,
      confirmButtonText:'Apagar',
      cancelButtonText:'Cancelar'
    }).then(res => {
      if (res.isConfirmed){
        paciente = null;
        salvarPacienteLocal();
        renderCardPaciente();
        Swal.fire({ icon:'success', title:'Removido', text:'Paciente apagado.' });
      }
    });
  });

  // Exportar PDF (menu lateral) -> fecha menu ao clicar
  document.getElementById('btnPDF').addEventListener('click', () => {
    fecharMenu(); // fechar imediatamente ap√≥s clique
    if (registros.length === 0){
      Swal.fire({ icon:'info', title:'Sem registros', text:'Adicione registros antes de exportar.' });
      return;
    }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Cabe√ßalho
    doc.setFontSize(18);
    doc.text('Relat√≥rio de Press√£o Arterial', 105, 18, { align: 'center' });

    doc.setFontSize(12);
    const linhaPaciente = paciente
      ? `Paciente: ${paciente.nome} ‚Ä¢ Idade: ${paciente.idade} ‚Ä¢ Tipo: ${paciente.tipo || '-'}`
      : 'Paciente n√£o cadastrado';
    doc.text(linhaPaciente, 105, 26, { align: 'center' });

    // Tabela
    const head = [['Press√£o', 'Data']];
    const body = ordenarPorDataDesc(registros).map(r => [r.pressao, r.data]);

    doc.autoTable({
      head,
      body,
      startY: 32,
      styles: { halign:'center', fontSize:12 },
      headStyles: { fillColor: [21,101,192], textColor:255 },
      alternateRowStyles: { fillColor: [245,248,254] },
      margin: { left: 18, right: 18 }
    });

    // Rodap√©
    const dataAtual = new Date();
    const rodape = `Gerado em ${String(dataAtual.getDate()).padStart(2,'0')}/${String(dataAtual.getMonth()+1).padStart(2,'0')}/${dataAtual.getFullYear()}`;
    doc.setFontSize(10);
    doc.text(rodape, 105, doc.internal.pageSize.getHeight() - 10, { align:'center' });

    doc.save('pressao_arterial.pdf');
  });

  // Apagar toda a tabela (menu lateral) -> fecha menu ao clicar
  document.getElementById('btnClear').addEventListener('click', () => {
    fecharMenu(); // fechar imediatamente ap√≥s clique
    if (registros.length === 0){
      Swal.fire({ icon:'info', title:'Tabela vazia', text:'N√£o h√° registros para apagar.' });
      return;
    }
    Swal.fire({
      title: 'Apagar todos os registros?',
      text: 'Essa a√ß√£o n√£o pode ser desfeita.',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#e74c3c',
      confirmButtonText: 'Apagar tudo',
      cancelButtonText: 'Cancelar'
    }).then(res => {
      if (res.isConfirmed){
        registros = [];
        salvarRegistros();
        renderTabela();
        Swal.fire({ icon:'success', title:'Tabela apagada', text:'Todos os registros foram removidos.' });
      }
    });
  });

  // Autoformata√ß√£o do campo de press√£o: 12080 => 120/80
  document.getElementById('pressao').addEventListener('input', (e) => {
    let v = e.target.value.replace(/\D/g,'');
    if (v.length > 3){ v = v.slice(0,3) + '/' + v.slice(3,5); }
    e.target.value = v;
  });

  // Menu lateral: abrir/fechar
  function abrirMenu(){
    sidebar.classList.add('show');
    overlay.classList.add('show');
  }
  function fecharMenu(){
    sidebar.classList.remove('show');
    overlay.classList.remove('show');
  }
  fab.addEventListener('click', abrirMenu);
  document.getElementById('btnClose').addEventListener('click', () => { fecharMenu(); });
  overlay.addEventListener('click', fecharMenu);

  // Fechar menu automaticamente ao clicar em qualquer bot√£o do menu (fallback geral)
  sidebar.addEventListener('click', (e) => {
    const target = e.target.closest('button');
    if (target) fecharMenu();
  });

  // Inicializa√ß√£o
  function init(){
    renderTabela();
    renderCardPaciente();
    document.getElementById("ano").textContent = new Date().getFullYear();
  }
  init();
  document.addEventListener('keydown', function (event) {
                if (event.ctrlKey && event.shiftKey && event.key === 'I') {
                    event.preventDefault();
                }
            });

            document.addEventListener('contextmenu', function (event) {
                event.preventDefault();
            });
            document.addEventListener('keydown', function (e) {
                if (e.ctrlKey && (e.key === 'u' || e.key === 'U')) {
                    e.preventDefault();
                }
                if (e.key === 'F12') {
                    e.preventDefault();
                }
            });
</script>
</body>
</html>
