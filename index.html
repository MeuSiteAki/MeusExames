<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel de Saúde do KAKA</title>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <!-- CryptoJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root {
      --bg1: #f9fafb; --bg2: #eef2f7; --card: #ffffff; --text: #1f2937;
      --primary: #2563eb; --primary-hover: #1d4ed8; --accent: #0f172a;
      --blue: #2563eb; --orange: #f97316; --red: #dc2626;
      --blue-bg: #dbeafe; --orange-bg: #ffedd5; --red-bg: #fee2e2;
      --shadow: 0 8px 24px rgba(0,0,0,0.08); --radius: 16px;
    }
    body { margin:0; font-family: 'Inter', 'Segoe UI', Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, var(--bg1), var(--bg2)); min-height: 100vh; color: var(--text); }

    /* Login */
    .login-screen { position: fixed; inset:0; background: linear-gradient(135deg, #dbeafe, #eff6ff);
      display:flex; align-items:center; justify-content:center; z-index:2000; }
    .login-box { background:#fff; padding:28px; border-radius:16px; width:360px; text-align:center; box-shadow:0 10px 28px rgba(0,0,0,0.16); }
    .login-input { width:100%; padding:12px; border:1px solid #cbd5e1; border-radius:10px; margin-bottom:10px; font-size:14px; }
    .login-actions { display:flex; flex-direction:column; gap:8px; }
    .btn-login { background:var(--primary); color:#fff; border:none; border-radius:10px; padding:12px; font-weight:700; cursor:pointer; }
    .btn-login:hover { background:#1d4ed8; }
    .btn-forgot { background:#f3f4f6; color:#111827; border:none; border-radius:10px; padding:12px; font-weight:700; cursor:pointer; }
    .btn-forgot:hover { background:#e5e7eb; }
    #loginHint { margin-top:10px; font-size:13px; color:#dc2626; font-weight:700; display:none; }

    /* Floating menu */
    .menu-btn { position: fixed; right: 20px; bottom: 20px; width: 56px; height: 56px; border-radius: 50%; border: none;
      background: var(--primary); color:#fff; font-size:22px; display:flex; align-items:center; justify-content:center;
      cursor:pointer; box-shadow: var(--shadow); z-index:1001; transition: transform .25s ease, background .25s ease; }
    .menu-btn:hover { background: var(--primary-hover); transform: rotate(90deg) scale(1.05); }

    /* Sidebar */
    .sidebar { position: fixed; left: -305px; top: 0; width: 280px; height: 100vh; background: var(--accent); color: #fff;
      padding: 80px 20px 20px; transition: left .3s ease; z-index: 1000; box-shadow: 12px 0 24px rgba(0,0,0,.25);
      display:flex; flex-direction:column; }
    .sidebar.active { left: 0; }
    .sidebar h3 { margin:0 0 12px; font-weight:800; font-size:18px; display:flex; align-items:center; gap:8px; }
    .nav-link { display:flex; align-items:center; gap:10px; padding:12px 14px; border-radius:10px; color:#e5e7eb; text-decoration:none; margin-bottom:8px; font-weight:800; font-size:15px; }
    .nav-link i { color:#93c5fd; }
    .nav-link:hover { background: rgba(59,130,246,0.35); color:#fff; transform: translateX(3px); }
    .nav-link.active { background: rgba(59,130,246,0.55); color:#fff; }
    .sidebar-buttons { display:flex; flex-direction:column; gap:8px; margin:12px 0; }
    .btn { padding:10px; border:none; border-radius:10px; cursor:pointer; font-weight:700; display:inline-flex; align-items:center; gap:6px; justify-content:center; font-size:12px; }
    .btn.secondary { background:#f3f4f6; color:#111827; }
    .btn.secondary:hover { background:#e5e7eb; }
    .btn-remove { background: var(--red) !important; color:#fff !important; }
    .btn-remove:hover { background:#b91c1c !important; }
    .sidebar-footer { margin-top:230px; }

    /* Content */
    .container { max-width: 1200px; margin: 30px auto; padding: 0 16px; }
    .header { display:flex; flex-wrap:wrap; gap:20px; justify-content:space-between; margin-bottom:20px; }
    .title-card { flex:1; background: linear-gradient(135deg, #2563eb, #9333ea); color:#fff; padding:20px 28px; border-radius:16px;
      box-shadow: 0 6px 16px rgba(0,0,0,.15); display:flex; align-items:center; justify-content:center; }
    .title-card h1 { margin:0; font-size:26px; font-weight:800; }
    .patient-card { min-width:280px; background:#fff; border-radius:16px; padding:18px 24px; box-shadow: 0 6px 16px rgba(0,0,0,.1); border:1px solid #e5e7eb; }
    .patient-card h2 { margin:0; font-size:20px; font-weight:700; color:#111827; }
    .patient-card p { margin:6px 0 0; font-size:14px; color:#6b7280; }

    .card { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); padding: 24px; }
    .tab { display:none; } .tab.active { display:block; }
    .grid { display:grid; grid-template-columns: repeat(2, 1fr); gap:16px; }
    @media (max-width: 700px) { .grid { grid-template-columns: 1fr; } }
    label { font-size:13px; font-weight:600; margin-bottom:6px; display:block; }
    input, select, textarea { width:100%; padding:12px; border:1px solid #e5e7eb; border-radius:12px; background:#fff; color:#111827; }
    input::placeholder { color:#9ca3af; }
    .actions { display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; align-items:center; }

    .history-list { display:flex; flex-direction:column; gap:16px; margin-top:8px; }
    .history-card { background:#fff; border-radius:16px; padding:16px; box-shadow: var(--shadow); border:1px solid #e5e7eb; }
    .history-title { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .history-item { border:1px solid #e5e7eb; border-radius:12px; padding:12px; }
    .history-head { display:flex; justify-content:space-between; align-items:center; color:#374151; font-size:13px; margin-bottom:6px; }
    .history-values { display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; font-size:14px; }
    @media (max-width:600px) { .history-values { grid-template-columns: 1fr; } }

    .badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:700; margin-left:6px; }
    .badge-blue { color: var(--blue); background: var(--blue-bg); }
    .badge-orange { color: var(--orange); background: var(--orange-bg); }
    .badge-red { color: var(--red); background: var(--red-bg); }

    .input-inline { flex:1; padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; background:#fff; }
    .whatsapp-btn { background:#25D366; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer; }
    .whatsapp-btn:hover { background:#1ebe5d; }

    /* Profissionais */
    .pro-header { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:8px; }
    .pro-info { font-size:13px; color:#475569; }
    .table { width:100%; border-collapse: collapse; margin-top:8px; }
    .table th, .table td { border:1px solid #e5e7eb; padding:8px; text-align:left; font-size:13px; }
    .table th { background: #f3f4f6; font-weight:800; }
    .chip { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#eef2ff; color:#1e3a8a; font-weight:700; font-size:12px; }
    .muted { color:#6b7280; font-size:12px; }
    .exams-grid { display:grid; grid-template-columns: repeat(2, 1fr); gap:8px; text-align:left; }
    @media (max-width:600px) { .exams-grid { grid-template-columns: 1fr; } }

    /* Lista vertical para exames no pop-up */
    .exams-list label { display:block; margin-bottom:6px; }
    /* Mantém checkbox antes do texto e tudo na mesma linha */
.exams-list label {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 6px;
  white-space: nowrap; /* evita quebra no meio do nome */
}

  </style>
</head>
<body>
  <!-- Login -->
  <div id="loginScreen" class="login-screen" style="display:flex;">
    <div class="login-box">
      <img src="https://cdn-icons-png.flaticon.com/512/2966/2966486.png" alt="Logo Saúde" class="login-logo" style="width:84px; border-radius:12px; margin-bottom:14px;">
      <h2 style="margin:0 0 6px; color:#1e3a8a; font-weight:800; font-size:20px;">Bem-vindo ao KAKA Saúde</h2>
      <p style="margin:0 0 16px; color:#475569; font-size:13px;">Digite sua senha para entrar</p>
      <input type="password" id="loginPassword" class="login-input" placeholder="Sua senha">
      <div class="login-actions">
        <button id="loginBtn" class="btn-login"><i class="fa-solid fa-right-to-bracket"></i> Entrar</button>
        <button id="forgotBtnLogin" class="btn-forgot"><i class="fa-solid fa-circle-question"></i> Esqueci minha senha</button>
      </div>
      <p id="loginHint"></p>
    </div>
  </div>

  <!-- Botão flutuante -->
  <button class="menu-btn" id="menuBtn" aria-label="Abrir menu"><i class="fa-solid fa-bars"></i></button>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar" aria-label="Menu">
    <h3><i class="fa-solid fa-table-columns"></i> Painel</h3>

    <a href="#" class="nav-link active" data-tab="tab-dados"><i class="fa-solid fa-user"></i> Pacientes</a>
    <a href="#" class="nav-link" data-tab="tab-exames"><i class="fa-solid fa-vial"></i> Exames</a>
    <a href="#" class="nav-link" data-tab="tab-historico"><i class="fa-solid fa-clock-rotate-left"></i> Histórico</a>
    <a href="#" class="nav-link" data-tab="tab-profissionais"><i class="fa-solid fa-user-doctor"></i> Profissionais</a>

    <button id="btnToggleConfig" class="btn secondary" style="margin-top:8px;"><i class="fa-solid fa-gear"></i> Configurações</button>
    <div id="configButtons" class="sidebar-buttons" style="display:none;">
      <button class="btn secondary" id="btnTrocarSenha"><i class="fa-solid fa-key"></i> Trocar senha</button>
      <button class="btn secondary" id="btnEditarDica"><i class="fa-solid fa-lightbulb"></i> Dica de senha</button>
      <button class="btn secondary" id="btnForgot"><i class="fa-solid fa-circle-question"></i> Esqueci minha senha</button>
    </div>

    <div class="sidebar-footer">
      <button class="btn secondary" id="btnLogout"><i class="fa-solid fa-right-from-bracket"></i> Sair</button>
    </div>
  </aside>

  <!-- Main -->
  <main class="container" id="appRoot" style="display:none;">
    <div class="header">
      <div class="title-card">
        <h1><i class="fa-solid fa-heart-pulse"></i> Painel de Saúde</h1>
      </div>
      <div class="patient-card" id="patientCard">
        <h2 id="patientName"><i class="fa-solid fa-user"></i> Paciente</h2>
        <p id="patientAge"><i class="fa-solid fa-cake-candles"></i> Idade: --</p>
      </div>
    </div>

    <section class="card">
      <!-- Pacientes -->
      <div id="tab-dados" class="tab active">
        <form id="formDados">
          <input type="hidden" id="pacienteId" />
          <div class="grid">
            <div>
              <label for="nome"><i class="fa-solid fa-user"></i> Nome completo</label>
              <input id="nome" type="text" placeholder="Seu nome" />
            </div>
            <div>
              <label for="nascimento"><i class="fa-solid fa-cake-candles"></i> Data de nascimento</label>
              <input id="nascimento" type="text" maxlength="10" placeholder="dd/mm/aaaa" />
            </div>
            <div>
              <label for="endereco"><i class="fa-solid fa-house"></i> Endereço</label>
              <input id="endereco" type="text" placeholder="Rua, número, bairro" />
            </div>
            <div>
              <label for="telefone"><i class="fa-solid fa-phone"></i> Telefone</label>
              <input id="telefone" type="tel" placeholder="(xx) xxxxx-xxxx" />
            </div>
            <div>
              <label for="cpf"><i class="fa-solid fa-id-card"></i> CPF</label>
              <input id="cpf" type="text" placeholder="000.000.000-00" />
            </div>
            <div>
              <label for="agente"><i class="fa-solid fa-user-nurse"></i> Agente de Saúde</label>
              <input id="agente" type="text" placeholder="Nome do agente" />
            </div>
            <div>
              <label for="sangue"><i class="fa-solid fa-droplet"></i> Tipo sanguíneo</label>
              <select id="sangue">
                <option value="">Selecione</option>
                <option>A+</option><option>A-</option>
                <option>B+</option><option>B-</option>
                <option>AB+</option><option>AB-</option>
                <option>O+</option><option>O-</option>
              </select>
            </div>
          </div>
          <div class="actions">
            <button class="btn secondary" type="button" id="togglePacientes"><i class="fa-solid fa-users"></i> Mostrar Pacientes</button>
            <button class="btn secondary" type="button" id="limparDados"><i class="fa-solid fa-eraser"></i> Limpar</button>
            <button class="btn btn-remove" type="button" id="apagarPacienteSelecionado" style="display:none;"><i class="fa-solid fa-user-xmark"></i> Remover selecionado</button>
            <button class="btn" type="submit" style="background:#2563eb; color:#fff;"><i class="fa-solid fa-floppy-disk"></i> Salvar paciente</button>
          </div>
        </form>

        <div class="card" style="margin-top:16px;">
          <div class="actions" style="margin-bottom:8px;">
            <input type="text" id="buscaPacientes" class="input-inline" placeholder="Buscar por nome, CPF ou agente" />
          </div>
          <h3><i class="fa-solid fa-users"></i> Pacientes cadastrados</h3>
          <div id="listaPacientes" class="history-list" style="display:none;"></div>
        </div>
      </div>

      <!-- Exames -->
      <div id="tab-exames" class="tab">
        <form id="formExames">
          <input type="hidden" id="exameId" />
          <div class="grid">
            <div>
              <label for="pacienteSelect"><i class="fa-solid fa-user-check"></i> Paciente</label>
              <select id="pacienteSelect"></select>
            </div>
            <div>
              <label for="glicemia"><i class="fa-solid fa-syringe"></i> Glicemia (mg/dL)</label>
              <input id="glicemia" type="number" min="0" step="1" placeholder="Ex: 95" />
            </div>
            <div>
              <label for="colesterol"><i class="fa-solid fa-heart-pulse"></i> Colesterol total (mg/dL)</label>
              <input id="colesterol" type="number" min="0" step="1" placeholder="Ex: 180" />
            </div>
            <div>
              <label for="trigliceridios"><i class="fa-solid fa-vial"></i> Triglicerídeos (mg/dL)</label>
              <input id="trigliceridios" type="number" min="0" step="1" placeholder="Ex: 150" />
            </div>
            <div>
              <label for="pressao"><i class="fa-solid fa-stethoscope"></i> Pressão arterial</label>
              <input id="pressao" type="text" maxlength="7" placeholder="Ex: 120/80" />
            </div>
            <div>
              <label for="bpm"><i class="fa-solid fa-heart"></i> BPM (batimentos por minuto)</label>
              <input id="bpm" type="number" min="0" step="1" placeholder="Ex: 72" />
            </div>
          </div>
          <div class="actions">
            <button class="btn secondary" type="button" id="limparExame"><i class="fa-solid fa-eraser"></i> Limpar</button>
            <button class="btn" type="submit" style="background:#2563eb; color:#fff;"><i class="fa-solid fa-floppy-disk"></i> Salvar exame</button>
          </div>
        </form>
      </div>

      <!-- Histórico -->
      <div id="tab-historico" class="tab">
        <div class="actions" style="margin-bottom:8px;">
          <input type="text" id="buscaHistorico" class="input-inline" placeholder="Filtrar por nome, data ou valor (ex: Maria, 120/80)" />
          <button class="btn secondary" type="button" id="ordenarRecente"><i class="fa-solid fa-arrow-down-wide-short"></i> Mais recentes</button>
          <button class="btn secondary" type="button" id="ordenarAntigo"><i class="fa-solid fa-arrow-up-short-wide"></i> Mais antigos</button>
          <button class="btn secondary" type="button" id="salvarPDF"><i class="fa-solid fa-file-pdf"></i> Exportar PDF</button>
          <button class="btn btn-remove" type="button" id="apagarHistorico"><i class="fa-solid fa-trash"></i> Apagar todo histórico</button>
        </div>
        <div id="listaHistorico" class="history-list"></div>
      </div>

      <!-- Profissionais -->
      <div id="tab-profissionais" class="tab">
        <div class="pro-header">
          <div class="chip"><i class="fa-solid fa-stethoscope"></i> Médico(a): 10 consultas diárias (Seg-Sex)</div>
          <div class="chip"><i class="fa-solid fa-user-nurse"></i> Enfermeiro(a): 15 consultas diárias (Seg-Sex)</div>
        </div>
        <p class="pro-info">Selecione o profissional e agende uma consulta. A data deve ser em dia útil (segunda a sexta). Se um paciente estiver selecionado, os dados serão usados automaticamente.</p>

        <div class="actions">
          <button class="btn" id="btnAgendaMedico" style="background:#2563eb; color:#fff;"><i class="fa-solid fa-user-doctor"></i> Agendar Médico(a)</button>
          <button class="btn" id="btnAgendaEnfermeiro" style="background:#2563eb; color:#fff;"><i class="fa-solid fa-user-nurse"></i> Agendar Enfermeiro(a)</button>
          <button class="btn secondary" id="btnExamesLab"><i class="fa-solid fa-vials"></i> Exames laboratoriais</button>
          <button class="btn secondary" id="btnExportAgenda"><i class="fa-solid fa-file-pdf"></i> Exportar agenda PDF</button>
          <button class="btn btn-remove" id="btnLimparAgenda"><i class="fa-solid fa-trash"></i> Limpar agenda do dia</button>
        </div>

        <div class="card" style="margin-top:12px;">
          <h3><i class="fa-solid fa-calendar-days"></i> Agenda</h3>
          <div class="actions" style="margin-bottom:8px;">
            <input type="date" id="agendaData" class="input-inline" />
            <button class="btn secondary" id="btnHoje"><i class="fa-solid fa-clock"></i> Hoje</button>
            <input type="text" id="buscaAgenda" class="input-inline" placeholder="Buscar na agenda por nome, CPF ou agente" />
            <span class="muted" id="vagasInfo"></span>
          </div>
          <table class="table" id="tabelaAgenda">
            <thead>
              <tr>
                <th>#</th>
                <th>Data</th>
                <th>Profissional</th>
                <th>Nome</th>
                <th>Endereço</th>
                <th>CPF</th>
                <th>Telefone</th>
                <th>Agente de Saúde</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ======== CHAVES E ESTADO ========
    const KEY_PAC = "pacientes_enc";
    const KEY_EXA = "exames_enc";
    const KEY_PASS = "painelSenha";
    const KEY_HINT = "painelHint";
    const KEY_LOGGED = "painelLogado";
    const KEY_AGD = "agenda_enc";

    let SECRET = "";
    let ordem = "desc";
    let pacienteSelecionado = null;

    // ======== CRIPTOGRAFIA ========
    function encSave(key, obj) {
      try {
        const text = JSON.stringify(obj);
        const cipher = CryptoJS.AES.encrypt(text, SECRET).toString();
        localStorage.setItem(key, cipher);
      } catch (e) { console.error("Erro ao salvar:", e); }
    }
    function encLoad(key, fallback) {
      try {
        const cipher = localStorage.getItem(key);
        if (!cipher) return fallback;
        const bytes = CryptoJS.AES.decrypt(cipher, SECRET);
        const text = bytes.toString(CryptoJS.enc.Utf8);
        if (!text) return fallback;
        return JSON.parse(text);
      } catch (e) { console.warn("Erro ao carregar/decifrar:", e); return fallback; }
    }

    // ======== LOGIN - DICA ========
    function showHintIfExists() {
      const hint = localStorage.getItem(KEY_HINT) || "";
      const el = document.getElementById("loginHint");
      if (hint) { el.textContent = `Dica: ${hint}`; el.style.display = "block"; el.style.color="#64748b"; el.style.fontWeight="600"; }
      else { el.style.display = "none"; }
    }

    document.getElementById("forgotBtnLogin").addEventListener("click", () => {
      const el = document.getElementById("loginHint");
      el.style.display = "block";
      el.style.color = "#dc2626";
      el.style.fontWeight = "700";
      el.innerHTML = "Esqueci minha senha: isso apagará TODOS os dados (pacientes, exames, agenda) e a senha atual.<br>Para prosseguir, confirme abaixo.";
      const confirmBtn = document.createElement("button");
      confirmBtn.className = "btn btn-remove";
      confirmBtn.style.marginTop = "10px";
      confirmBtn.innerHTML = '<i class="fa-solid fa-trash"></i> Apagar e recriar senha';
      confirmBtn.onclick = async () => {
        localStorage.removeItem(KEY_PAC);
        localStorage.removeItem(KEY_EXA);
        localStorage.removeItem(KEY_AGD);
        localStorage.removeItem(KEY_PASS);
        localStorage.removeItem(KEY_HINT);
        localStorage.removeItem(KEY_LOGGED);
        SECRET = "";
        el.textContent = "Dados apagados. Defina uma nova senha para recomeçar.";
      };
      if (!el.dataset.hasButton) {
        el.dataset.hasButton = "true";
        el.appendChild(confirmBtn);
      }
    });

    // ======== LOGIN ========
    document.getElementById("loginBtn").addEventListener("click", async () => {
      const senhaSalva = localStorage.getItem(KEY_PASS);
      const tentativa = document.getElementById("loginPassword").value.trim();

      if (!senhaSalva) {
        if (!tentativa) {
          const el = document.getElementById("loginHint");
          el.style.display = "block"; el.style.color = "#dc2626";
          el.textContent = "Defina uma senha para iniciar.";
          return;
        }
        const { value: hint } = await Swal.fire({
          title:"Dica de senha (opcional)",
          input:"text",
          inputPlaceholder:"Algo que te ajude a lembrar",
          showCancelButton:true,
          confirmButtonText:"Salvar"
        });
        localStorage.setItem(KEY_PASS, tentativa);
        if ((hint || "").trim()) localStorage.setItem(KEY_HINT, hint.trim());

        SECRET = tentativa;
        localStorage.setItem(KEY_LOGGED, "true");
        document.getElementById("loginScreen").style.display = "none";
        document.getElementById("appRoot").style.display = "block";
        setActiveTab("tab-dados");
        renderListaPacientes();
        carregarPacientesSelect();
        carregarHistorico();
        initAgendaDefaults();
        renderAgenda();
        return;
      }

      if (tentativa !== senhaSalva) {
        const el = document.getElementById("loginHint");
        el.style.display = "block"; el.style.color = "#dc2626";
        el.textContent = "Senha incorreta. Tente novamente.";
        return;
      }
      SECRET = senhaSalva;
      localStorage.setItem(KEY_LOGGED, "true");
      document.getElementById("loginScreen").style.display = "none";
      document.getElementById("appRoot").style.display = "block";
      setActiveTab("tab-dados");
      renderListaPacientes();
      carregarPacientesSelect();
      carregarHistorico();
      initAgendaDefaults();
      renderAgenda();
    });

    // ======== CONFIGURAÇÕES ========
    document.getElementById("btnToggleConfig").addEventListener("click", () => {
      const cfg = document.getElementById("configButtons");
      cfg.style.display = (cfg.style.display === "none" || cfg.style.display === "") ? "flex" : "none";
    });

    async function trocarSenha() {
      const senhaSalva = localStorage.getItem(KEY_PASS);
      if (!senhaSalva) { await Swal.fire({ icon:"error", title:"Nenhuma senha configurada" }); return; }
      const { value: atual } = await Swal.fire({
        title: "Senha atual", input: "password", inputPlaceholder: "Digite sua senha atual",
        confirmButtonText: "Continuar", showCancelButton: true
      });
      if (!atual) return;
      if (atual !== senhaSalva) { await Swal.fire({ icon:"error", title:"Senha incorreta" }); return; }

      const { value: dados } = await Swal.fire({
        title: "Nova senha e dica (opcional)",
        html: `
          <div style="text-align:left; font-size:13px; margin-bottom:6px;">Nova senha</div>
          <input id="swal-pass-new" class="swal2-input" type="password" placeholder="Digite a nova senha"/>
          <div style="text-align:left; font-size:13px; margin:10px 0 6px;">Dica de senha (opcional)</div>
          <input id="swal-hint-new" class="swal2-input" placeholder="Algo que te ajude a lembrar"/>
        `,
        focusConfirm: false,
        preConfirm: () => {
          const pass = document.getElementById("swal-pass-new").value?.trim();
          const hint = document.getElementById("swal-hint-new").value?.trim();
          if (!pass) { Swal.showValidationMessage("A nova senha é obrigatória."); return false; }
          return { pass, hint };
        },
        showCancelButton: true, confirmButtonText: "Salvar"
      });
      if (!dados || !dados.pass) return;

      SECRET = atual;
      const pacs = encLoad(KEY_PAC, []);
      const exas = encLoad(KEY_EXA, []);
      const agds = encLoad(KEY_AGD, []);
      localStorage.setItem(KEY_PASS, dados.pass);
      if ((dados.hint || "").trim()) localStorage.setItem(KEY_HINT, dados.hint.trim());
      else localStorage.removeItem(KEY_HINT);
      SECRET = dados.pass;
      encSave(KEY_PAC, pacs);
      encSave(KEY_EXA, exas);
      encSave(KEY_AGD, agds);
      await Swal.fire({ icon:"success", title:"Senha (e dica) alteradas!" });
      showHintIfExists();
    }
    document.getElementById("btnTrocarSenha").addEventListener("click", trocarSenha);

    async function editarDicaSenha() {
      const atual = localStorage.getItem(KEY_HINT) || "";
      const { value: nova } = await Swal.fire({
        title: "Definir dica de senha", input: "text", inputValue: atual,
        inputPlaceholder: "Opcional (visível no login)", showCancelButton: true, confirmButtonText: "Salvar"
      });
      if (nova === undefined) return;
      const hint = (nova || "").trim();
      if (hint) localStorage.setItem(KEY_HINT, hint); else localStorage.removeItem(KEY_HINT);
      await Swal.fire({ icon:"success", title:"Dica atualizada!" });
      showHintIfExists();
    }
    document.getElementById("btnEditarDica").addEventListener("click", editarDicaSenha);

    document.getElementById("btnForgot").addEventListener("click", () => {
      Swal.fire({
        icon: "info",
        title: "Esqueci minha senha",
        text: "Use o botão na tela de login para apagar dados e recriar sua senha."
      });
    });

    async function logout() {
      const confirm = await Swal.fire({
        title:"Sair do painel?",
        text:"A página será atualizada e pedirá a senha novamente.",
        icon:"question", showCancelButton:true, confirmButtonText:"Sair", cancelButtonText:"Cancelar"
      });
      if (!confirm.isConfirmed) return;
      localStorage.removeItem(KEY_LOGGED);
      location.reload();
    }
    document.getElementById("btnLogout").addEventListener("click", logout);

    // ======== SIDEBAR / TABS ========
    document.getElementById("menuBtn").onclick = ()=> document.getElementById("sidebar").classList.toggle("active");
    document.querySelectorAll(".nav-link").forEach(link => {
      link.addEventListener("click", (e) => {
        e.preventDefault();
        const tabId = link.getAttribute("data-tab");
        setActiveTab(tabId);
        document.getElementById("sidebar").classList.remove("active");
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
    });
    function setActiveTab(id) {
      document.querySelectorAll('.tab').forEach(t => { t.classList.remove('active'); t.style.display='none'; });
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      const tab = document.getElementById(id);
      if (tab) { tab.classList.add('active'); tab.style.display='block'; }
      const link = document.querySelector(`.nav-link[data-tab="${id}"]`);
      if (link) link.classList.add('active');
      history.pushState({ tab: id }, "", "#" + id);
      if (id === "tab-exames") carregarPacientesSelect();
      if (id === "tab-historico") carregarHistorico();
      if (id === "tab-profissionais") { initAgendaDefaults(); renderAgenda(); }
    }
    window.addEventListener("popstate", (event) => {
      const logado = localStorage.getItem(KEY_LOGGED) === "true";
      if (!logado) {
        document.getElementById("loginScreen").style.display = "flex";
        document.getElementById("appRoot").style.display = "none";
        return;
      }
      const tab = event.state?.tab || "tab-dados";
      document.querySelectorAll('.tab').forEach(t => { t.classList.remove('active'); t.style.display='none'; });
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      const el = document.getElementById(tab);
      if (el) { el.classList.add('active'); el.style.display='block'; }
      const nav = document.querySelector(`.nav-link[data-tab="${tab}"]`);
      if (nav) nav.classList.add('active');
      if (tab === "tab-exames") carregarPacientesSelect();
      if (tab === "tab-historico") carregarHistorico();
      if (tab === "tab-profissionais") { initAgendaDefaults(); renderAgenda(); }
    });

    // ======== UTILS ========
    function calcularIdadeDDMMAAAA(strData) {
      if (!strData || strData.length !== 10) return "";
      const [dia, mes, ano] = strData.split("/").map(Number);
      const nasc = new Date(ano, (mes - 1), dia);
      if (isNaN(nasc)) return "";
      const hoje = new Date();
      let idade = hoje.getFullYear() - nasc.getFullYear();
      const m = hoje.getMonth() - nasc.getMonth();
      if (m < 0 || (m === 0 && hoje.getDate() < nasc.getDate())) idade--;
      return idade;
    }
    document.getElementById("nascimento").addEventListener("input", (e) => {
      let v = e.target.value.replace(/\D/g, "");
      if (v.length > 2 && v.length <= 4) v = v.replace(/(\d{2})(\d+)/, "$1/$2");
      else if (v.length > 4) v = v.replace(/(\d{2})(\d{2})(\d+)/, "$1/$2/$3");
      e.target.value = v;
      const idade = calcularIdadeDDMMAAAA(e.target.value);
      document.getElementById("patientAge").innerHTML = `<i class="fa-solid fa-cake-candles"></i> ${idade !== "" ? `Idade: ${idade} anos` : "Idade: --"}`;
    });
    document.getElementById("pressao").addEventListener("input", (e) => {
      let v = e.target.value.replace(/\D/g, "");
      if (v.length > 3) v = v.replace(/(\d{2,3})(\d{1,3})/, "$1/$2");
      e.target.value = v;
    });
    function validarPressao(str) { if (!str) return true; return /^\s*\d{2,3}\s*\/\s*\d{1,3}\s*$/.test(str); }

    // ======== BADGES EXAMES ========
    function avaliarGlicemia(v) { const n = Number(v); if (!v && v !== 0) return { cls:"", msg:"" }; if (n < 60) return { cls:"badge-orange", msg:"Baixo" }; if (n <= 120) return { cls:"badge-blue", msg:"Normal" }; return { cls:"badge-red", msg:"Alto" }; }
    function avaliarColesterol(v) { const n = Number(v); if (!v && v !== 0) return { cls:"", msg:"" }; if (n < 200) return { cls:"badge-blue", msg:"Desejável" }; if (n < 240) return { cls:"badge-orange", msg:"Limítrofe" }; return { cls:"badge-red", msg:"Alto" }; }
    function avaliarTrigliceridios(v) { const n = Number(v); if (!v && v !== 0) return { cls:"", msg:"" }; if (n < 150) return { cls:"badge-blue", msg:"Normal" }; if (n < 200) return { cls:"badge-orange", msg:"Limítrofe" }; return { cls:"badge-red", msg:"Alto" }; }
    function avaliarBPM(v) { const n = Number(v); if (!v && v !== 0) return { cls:"", msg:"" }; if (n < 60) return { cls:"badge-orange", msg:"Baixo" }; if (n <= 100) return { cls:"badge-blue", msg:"Normal" }; return { cls:"badge-red", msg:"Alto" }; }
    function avaliarPressao(val) { if (!val || !val.includes("/")) return { cls:"", msg:"" }; const [s, d] = val.split("/").map(v => parseInt(v, 10)); if (isNaN(s) || isNaN(d)) return { cls:"", msg:"" }; if (s < 90 || d < 60) return { cls:"badge-orange", msg:"Baixa" }; if (s <= 139 && d <= 89) return { cls:"badge-blue", msg:"Normal" }; return { cls:"badge-red", msg:"Alta" }; }

    // ======== PACIENTES ========
    const formDados = document.getElementById("formDados");
    const limparDadosBtn = document.getElementById("limparDados");
    const listaPacientes = document.getElementById("listaPacientes");
    const togglePacientesBtn = document.getElementById("togglePacientes");
    const buscaPacientes = document.getElementById("buscaPacientes");

    formDados.addEventListener("submit", (e) => {
      e.preventDefault();
      const idInput = document.getElementById("pacienteId");
      const nome = document.getElementById("nome").value.trim();
      if (!nome) { Swal.fire({ icon:'error', title:'Informe o nome do paciente.' }); return; }
      const paciente = {
        id: idInput.value ? Number(idInput.value) : Date.now(),
        nome,
        nascimento: document.getElementById("nascimento").value.trim(),
        endereco: document.getElementById("endereco").value.trim(),
        telefone: document.getElementById("telefone").value.trim(),
        cpf: document.getElementById("cpf").value.trim(),
        agente: document.getElementById("agente").value.trim(),
        sangue: document.getElementById("sangue").value
      };
      let pacs = encLoad(KEY_PAC, []);
      const idx = pacs.findIndex(p => p.id === paciente.id);
      if (idx >= 0) pacs[idx] = paciente; else pacs.push(paciente);
      encSave(KEY_PAC, pacs);
      pacienteSelecionado = paciente;
      Swal.fire({ icon:'success', title: idx>=0 ? 'Paciente atualizado!' : 'Paciente salvo!', timer:1400, showConfirmButton:false });
      formDados.reset(); document.getElementById("pacienteId").value = "";
      atualizarHeaderPaciente(null);
      renderListaPacientes();
      carregarPacientesSelect();
    });

    limparDadosBtn.addEventListener("click", () => {
      formDados.reset(); document.getElementById("pacienteId").value = "";
      atualizarHeaderPaciente(null);
      pacienteSelecionado = null;
      document.getElementById("apagarPacienteSelecionado").style.display = "none";
    });

    buscaPacientes.addEventListener("input", renderListaPacientes);

    togglePacientesBtn.addEventListener("click", () => {
      const div = document.getElementById("listaPacientes");
      const isHidden = div.style.display === "none" || div.style.display === "";
      div.style.display = isHidden ? "block" : "none";
      togglePacientesBtn.innerHTML = isHidden
        ? '<i class="fa-solid fa-users"></i> Esconder Pacientes'
        : '<i class="fa-solid fa-users"></i> Mostrar Pacientes';
      if (isHidden) renderListaPacientes();
    });

    function renderListaPacientes() {
      let pacs = encLoad(KEY_PAC, []);
      listaPacientes.innerHTML = "";
      if (pacs.length === 0) {
        const vazio = document.createElement("div");
        vazio.className = "history-item";
        vazio.innerHTML = `<i class="fa-regular fa-folder-open"></i> Nenhum paciente cadastrado.`;
        listaPacientes.appendChild(vazio);
        return;
      }
      const termo = (buscaPacientes.value || "").toLowerCase().trim();
      if (termo) {
        pacs = pacs.filter(p =>
          (p.nome || "").toLowerCase().includes(termo) ||
          (p.cpf || "").toLowerCase().includes(termo) ||
          (p.agente || "").toLowerCase().includes(termo)
        );
      }
      pacs.sort((a,b)=> (a.nome||"").localeCompare(b.nome||""));

      pacs.forEach(p => {
        const item = document.createElement("div");
        item.className = "history-item";
        item.innerHTML = `
          <div class="history-head">
            <span><i class="fa-solid fa-user"></i> ${p.nome}</span>
            <span class="badge badge-blue">${p.sangue || "--"}</span>
          </div>
          <div class="history-values">
            <span><strong><i class="fa-solid fa-cake-candles"></i> Nasc.:</strong> ${p.nascimento || "--"}</span>
            <span><strong><i class="fa-solid fa-phone"></i> Tel.:</strong> ${p.telefone || "--"}</span>
            <span><strong><i class="fa-solid fa-id-card"></i> CPF:</strong> ${p.cpf || "--"}</span>
            <span><strong><i class="fa-solid fa-user-nurse"></i> Agente:</strong> ${p.agente || "--"}</span>
            <span><strong><i class="fa-solid fa-house"></i> End.:</strong> ${p.endereco || "--"}</span>
          </div>
          <div class="actions">
            <button class="btn secondary" aria-label="Selecionar"><i class="fa-solid fa-check"></i> Selecionar</button>
            <button class="btn secondary" aria-label="Editar"><i class="fa-solid fa-pen"></i> Editar</button>
            <button class="btn btn-remove" aria-label="Remover"><i class="fa-solid fa-trash"></i> Remover</button>
            <button class="whatsapp-btn" aria-label="WhatsApp"><i class="fa-brands fa-whatsapp"></i></button>
          </div>
        `;
        const [btnSel, btnEdit, btnDel, btnZap] = item.querySelectorAll(".actions .btn, .actions .whatsapp-btn");
        btnSel.addEventListener("click", () => {
          pacienteSelecionado = p;
          Swal.fire({ icon:'success', title:'Paciente selecionado', text:p.nome, timer:1000, showConfirmButton:false });
          setActiveTab("tab-exames");
          carregarPacientesSelect(p.id);
        });
        btnEdit.addEventListener("click", () => {
          setActiveTab("tab-dados");
          pacienteSelecionado = p;
          document.getElementById("pacienteId").value = p.id;
          document.getElementById("nome").value = p.nome || "";
          document.getElementById("nascimento").value = p.nascimento || "";
          document.getElementById("endereco").value = p.endereco || "";
          document.getElementById("telefone").value = p.telefone || "";
          document.getElementById("cpf").value = p.cpf || "";
          document.getElementById("agente").value = p.agente || "";
          document.getElementById("sangue").value = p.sangue || "";
          atualizarHeaderPaciente(p);
          const remSel = document.getElementById("apagarPacienteSelecionado");
          remSel.style.display = "inline-flex";
          remSel.onclick = () => {
            Swal.fire({
              title: 'Remover paciente selecionado?',
              text: 'Exames associados NÃO serão apagados automaticamente.',
              icon: 'warning', showCancelButton:true, confirmButtonText:'Remover', cancelButtonText:'Cancelar'
            }).then(res => {
              if (res.isConfirmed) {
                let lista = encLoad(KEY_PAC, []);
                const novos = lista.filter(pp => pp.id !== p.id);
                encSave(KEY_PAC, novos);
                pacienteSelecionado = null;
                formDados.reset(); document.getElementById("pacienteId").value = "";
                atualizarHeaderPaciente(null);
                renderListaPacientes();
                carregarPacientesSelect();
                Swal.fire('Removido!', 'Paciente excluído.', 'success');
                remSel.style.display = "none";
              }
            });
          };
        });
        btnDel.addEventListener("click", () => {
          Swal.fire({
            title: 'Remover paciente?',
            text: 'Exames associados NÃO serão apagados automaticamente.',
            icon: 'warning', showCancelButton:true, confirmButtonText:'Remover', cancelButtonText:'Cancelar'
          }).then(res => {
            if (res.isConfirmed) {
              let lista = encLoad(KEY_PAC, []);
              const novos = lista.filter(pp => pp.id !== p.id);
              encSave(KEY_PAC, novos);
              if (pacienteSelecionado && pacienteSelecionado.id === p.id) pacienteSelecionado = null;
              renderListaPacientes();
              carregarPacientesSelect();
              Swal.fire('Removido!', 'Paciente excluído.', 'success');
            }
          });
        });
        btnZap.addEventListener("click", () => {
          const tel = (p.telefone || "").replace(/\D/g,"");
          if (tel.length < 10) { Swal.fire({icon:"info", title:"Telefone inválido"}); return; }
          window.open(`https://wa.me/55${tel}`, "_blank");
        });

        listaPacientes.appendChild(item);
      });
    }

    function atualizarHeaderPaciente(p) {
      const nameEl = document.getElementById("patientName");
      const ageEl = document.getElementById("patientAge");
      if (p) {
        nameEl.innerHTML = `<i class="fa-solid fa-user"></i> ${p.nome}`;
        const idade = calcularIdadeDDMMAAAA(p.nascimento);
        ageEl.innerHTML = `<i class="fa-solid fa-cake-candles"></i> ${idade !== "" ? `Idade: ${idade} anos` : "Idade: --"}`;
      } else {
        nameEl.innerHTML = `<i class="fa-solid fa-user"></i> Paciente`;
        ageEl.innerHTML = `<i class="fa-solid fa-cake-candles"></i> Idade: --`;
      }
    }

    // ======== EXAMES ========
    const formExames = document.getElementById("formExames");
    const limparExameBtn = document.getElementById("limparExame");
    const pacienteSelect = document.getElementById("pacienteSelect");

    function carregarPacientesSelect(preselectId=null) {
      const pacs = encLoad(KEY_PAC, []);
      pacienteSelect.innerHTML = "";
      if (pacs.length === 0) {
        const opt = document.createElement("option");
        opt.value = ""; opt.textContent = "Cadastre um paciente primeiro";
        pacienteSelect.appendChild(opt);
        return;
      }
      pacs.sort((a,b)=> (a.nome||"").localeCompare(b.nome||""));
      pacs.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id; opt.textContent = p.nome;
        pacienteSelect.appendChild(opt);
      });
      if (preselectId) pacienteSelect.value = preselectId;
      const current = pacs.find(pp => pp.id === Number(pacienteSelect.value));
      atualizarHeaderPaciente(current || null);
      const exaId = document.getElementById("exameId").value;
      if (!exaId) formExames.reset();
    }

    pacienteSelect.addEventListener("change", () => {
      const pacs = encLoad(KEY_PAC, []);
      const current = pacs.find(pp => pp.id === Number(pacienteSelect.value));
      atualizarHeaderPaciente(current || null);
      pacienteSelecionado = current || null;
    });

    formExames.addEventListener("submit", (e) => {
      e.preventDefault();
      const pid = Number(pacienteSelect.value);
      if (!pid) { Swal.fire({ icon:'error', title:'Selecione um paciente.' }); return; }
      const pressao = document.getElementById("pressao").value.trim();
      if (!validarPressao(pressao)) { Swal.fire({ icon:'error', title:'Formato inválido', text:'Pressão deve ser algo como 120/80.' }); return; }

      const exas = encLoad(KEY_EXA, []);
      const editIdVal = document.getElementById("exameId").value;
      const original = editIdVal ? exas.find(x => x.id === Number(editIdVal)) : null;

      const exame = {
        id: editIdVal ? Number(editIdVal) : Date.now(),
        pacienteId: pid,
        dataISO: original?.dataISO || new Date().toISOString(),
        glicemia: document.getElementById("glicemia").value.trim() || "",
        colesterol: document.getElementById("colesterol").value.trim() || "",
        trigliceridios: document.getElementById("trigliceridios").value.trim() || "",
        pressao: pressao || "",
        bpm: document.getElementById("bpm").value.trim() || ""
      };

      const idx = exas.findIndex(e => e.id === exame.id);
      if (idx >= 0) exas[idx] = exame; else exas.push(exame);
      encSave(KEY_EXA, exas);

      document.getElementById("exameId").value = "";
      formExames.reset();
      Swal.fire({ icon:'success', title: idx>=0 ? 'Exame atualizado!' : 'Exame salvo!', timer:1400, showConfirmButton:false });
      setActiveTab("tab-historico");
      carregarHistorico();
    });

    limparExameBtn.addEventListener("click", () => {
      document.getElementById("exameId").value = "";
      formExames.reset();
    });

    // ======== HISTÓRICO ========
    const buscaHistorico = document.getElementById("buscaHistorico");
    const listaHistorico = document.getElementById("listaHistorico");
    document.getElementById("ordenarRecente").addEventListener("click", () => { ordem = "desc"; carregarHistorico(); });
    document.getElementById("ordenarAntigo").addEventListener("click", () => { ordem = "asc"; carregarHistorico(); });
    buscaHistorico.addEventListener("input", carregarHistorico);

    function carregarHistorico() {
      const pacs = encLoad(KEY_PAC, []);
      let exas = encLoad(KEY_EXA, []);

      exas.sort((a, b) => ordem === "desc" ? new Date(b.dataISO) - new Date(a.dataISO) : new Date(a.dataISO) - new Date(b.dataISO));

      const termo = (buscaHistorico.value || "").toLowerCase().trim();
      if (termo) {
        exas = exas.filter(ex => {
          const p = pacs.find(pp => pp.id === ex.pacienteId);
          const nome = (p ? p.nome : "").toLowerCase();
          const dataFmt = new Date(ex.dataISO).toLocaleString("pt-BR", { dateStyle: "short", timeStyle: "short" }).toLowerCase();
          return (
            nome.includes(termo) || dataFmt.includes(termo) ||
            String(ex.glicemia).toLowerCase().includes(termo) ||
            String(ex.colesterol).toLowerCase().includes(termo) ||
            String(ex.trigliceridios).toLowerCase().includes(termo) ||
            String(ex.pressao).toLowerCase().includes(termo) ||
            String(ex.bpm).toLowerCase().includes(termo)
          );
        });
      }

      const grupo = {};
      exas.forEach(ex => { if (!grupo[ex.pacienteId]) grupo[ex.pacienteId] = []; grupo[ex.pacienteId].push(ex); });

      listaHistorico.innerHTML = "";

      const ids = Object.keys(grupo);
      if (ids.length === 0) {
        const vazio = document.createElement("div");
        vazio.className = "history-item";
        vazio.innerHTML = `<i class="fa-regular fa-folder-open"></i> Nenhum exame encontrado.`;
        listaHistorico.appendChild(vazio);
        return;
      }

      ids.forEach(pidStr => {
        const pid = Number(pidStr);
        const p = pacs.find(pp => pp.id === pid);

        const card = document.createElement("div");
        card.className = "history-card";

        const title = document.createElement("div");
        title.className = "history-title";
        title.innerHTML = `
          <h3><i class="fa-solid fa-user"></i> ${p ? p.nome : "Paciente removido"} ${p && p.sangue ? `<span class="badge badge-blue">${p.sangue}</span>` : ""}</h3>
          <span><i class="fa-solid fa-cake-candles"></i> ${p && p.nascimento ? p.nascimento : "--"}</span>
        `;
        card.appendChild(title);

        grupo[pid].forEach(exame => {
          const dataFmt = new Date(exame.dataISO).toLocaleString("pt-BR", { dateStyle: "short", timeStyle: "short" });
          const g = avaliarGlicemia(exame.glicemia);
          const c = avaliarColesterol(exame.colesterol);
          const t = avaliarTrigliceridios(exame.trigliceridios);
          const pr = avaliarPressao(exame.pressao);
          const b = avaliarBPM(exame.bpm);

          const item = document.createElement("div");
          item.className = "history-item";

          const head = document.createElement("div");
          head.className = "history-head";
          head.innerHTML = `
            <span><i class="fa-solid fa-calendar-day"></i> ${dataFmt}</span>
            <span class="badge badge-blue"><i class="fa-solid fa-vial"></i> Exame</span>
          `;

          const values = document.createElement("div");
          values.className = "history-values";
          values.innerHTML = `
            <div><strong><i class="fa-solid fa-user"></i> Paciente:</strong> ${p ? p.nome : "--"}</div>
            <div><strong><i class="fa-solid fa-syringe"></i> Glicemia:</strong> ${exame.glicemia || "--"} ${g.msg ? `<span class="badge ${g.cls}">${g.msg}</span>` : ""}</div>
            <div><strong><i class="fa-solid fa-heart-pulse"></i> Colesterol:</strong> ${exame.colesterol || "--"} ${c.msg ? `<span class="badge ${c.cls}">${c.msg}</span>` : ""}</div>
            <div><strong><i class="fa-solid fa-vial"></i> Triglicerídeos:</strong> ${exame.trigliceridios || "--"} ${t.msg ? `<span class="badge ${t.cls}">${t.msg}</span>` : ""}</div>
            <div><strong><i class="fa-solid fa-stethoscope"></i> Pressão:</strong> ${exame.pressao || "--"} ${pr.msg ? `<span class="badge ${pr.cls}">${pr.msg}</span>` : ""}</div>
            <div><strong><i class="fa-solid fa-heart"></i> BPM:</strong> ${exame.bpm || "--"} ${b.msg ? `<span class="badge ${b.cls}">${b.msg}</span>` : ""}</div>
          `;

          const actions = document.createElement("div");
          actions.className = "actions";
          const editarBtn = document.createElement("button");
          editarBtn.className = "btn secondary";
          editarBtn.innerHTML = `<i class="fa-solid fa-pen"></i> Editar`;
          editarBtn.addEventListener("click", () => editarExame(exame.id));

          const removerBtn = document.createElement("button");
          removerBtn.className = "btn btn-remove";
          removerBtn.innerHTML = `<i class="fa-solid fa-trash"></i> Remover`;
          removerBtn.addEventListener("click", () => {
            Swal.fire({
              title: 'Remover este exame?', text: "Essa ação não pode ser desfeita.",
              icon: 'warning', showCancelButton: true, confirmButtonText: 'Sim, remover', cancelButtonText: 'Cancelar'
            }).then((result) => {
              if (result.isConfirmed) {
                removerExame(exame.id);
                Swal.fire('Removido!', 'O exame foi excluído.', 'success');
              }
            });
          });

          actions.appendChild(editarBtn);
          actions.appendChild(removerBtn);
          item.appendChild(head);
          item.appendChild(values);
          item.appendChild(actions);
          card.appendChild(item);
        });

        listaHistorico.appendChild(card);
      });
    }

    function editarExame(exameId) {
      const exas = encLoad(KEY_EXA, []);
      const ex = exas.find(e => e.id === exameId);
      if (!ex) return;
      setActiveTab("tab-exames");
      document.getElementById("exameId").value = ex.id;
      carregarPacientesSelect(ex.pacienteId);
      document.getElementById("glicemia").value = ex.glicemia || "";
      document.getElementById("colesterol").value = ex.colesterol || "";
      document.getElementById("trigliceridios").value = ex.trigliceridios || "";
      document.getElementById("pressao").value = ex.pressao || "";
      document.getElementById("bpm").value = ex.bpm || "";
      Swal.fire({ icon: "info", title: "Editando exame", text: "Altere os valores e clique em salvar." });
    }

    function removerExame(id) {
      const exas = encLoad(KEY_EXA, []);
      const novos = exas.filter(e => e.id !== id);
      encSave(KEY_EXA, novos);
      carregarHistorico();
    }

    document.getElementById("apagarHistorico").addEventListener("click", () => {
      Swal.fire({
        title: "Apagar todo histórico?",
        text: "Isso removerá todos os exames de todos os pacientes.",
        icon: "warning", showCancelButton: true, confirmButtonText: "Sim, apagar", cancelButtonText: "Cancelar"
      }).then(res => {
        if (res.isConfirmed) {
          localStorage.removeItem(KEY_EXA);
          carregarHistorico();
          formExames.reset();
          document.getElementById("exameId").value = "";
          Swal.fire("Apagado!", "Todo o histórico foi removido.", "success");
        }
      });
    });

    document.getElementById("salvarPDF").addEventListener("click", () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const pacs = encLoad(KEY_PAC, []);
      let exas = encLoad(KEY_EXA, []);
      exas.sort((a, b) => new Date(b.dataISO) - new Date(a.dataISO));

      doc.setFontSize(18);
      doc.text("Relatório de Saúde", 14, 20);
      doc.setFontSize(11);
      doc.text("Gerado em: " + new Date().toLocaleString("pt-BR"), 14, 28);

      let y = 36;
      doc.setFontSize(13); doc.text("Pacientes cadastrados", 14, y); y += 8; doc.setFontSize(11);
      if (pacs.length === 0) { doc.text("Nenhum paciente.", 14, y); y += 10; }
      else {
        pacs.sort((a,b)=> (a.nome||"").localeCompare(b.nome||""));
        pacs.forEach((p, i) => {
          doc.text(`${i+1}. ${p.nome || "--"} | Nasc.: ${p.nascimento || "--"} | Tel.: ${p.telefone || "--"} | CPF: ${p.cpf || "--"} | Agente: ${p.agente || "--"} | Sangue: ${p.sangue || "--"}`, 14, y);
          y += 6; if (y > 270) { doc.addPage(); y = 20; }
        });
        y += 4;
      }

      doc.setFontSize(13); doc.text("Exames por paciente", 14, y); y += 8; doc.setFontSize(11);
      if (exas.length === 0) { doc.text("Nenhum exame registrado.", 14, y); }
      else {
        const grupo = {}; exas.forEach(ex => { if (!grupo[ex.pacienteId]) grupo[ex.pacienteId] = []; grupo[ex.pacienteId].push(ex); });
        Object.keys(grupo).forEach(pidStr => {
          const pid = Number(pidStr);
          const p = pacs.find(pp => pp.id === pid);
          doc.text(`Paciente: ${p ? p.nome : "Paciente removido"} (${p && p.sangue ? p.sangue : "--"})`, 14, y); y += 6;
          grupo[pid].forEach((ex, idx) => {
            const dataFmt = new Date(ex.dataISO).toLocaleString("pt-BR");
            doc.text(`  ${idx+1}. ${dataFmt}`, 14, y); y += 6;
            doc.text(`     Glicemia: ${ex.glicemia || "--"} (${avaliarGlicemia(ex.glicemia).msg || ""}) | Colesterol: ${ex.colesterol || "--"} (${avaliarColesterol(ex.colesterol).msg || ""}) | Triglicerídeos: ${ex.trigliceridios || "--"} (${avaliarTrigliceridios(ex.trigliceridios).msg || ""})`, 14, y); y += 6;
            doc.text(`     Pressão: ${ex.pressao || "--"} (${avaliarPressao(ex.pressao).msg || ""}) | BPM: ${ex.bpm || "--"} (${avaliarBPM(ex.bpm).msg || ""})`, 14, y); y += 8;
            if (y > 270) { doc.addPage(); y = 20; }
          });
          y += 4; if (y > 270) { doc.addPage(); y = 20; }
        });
      }

      doc.save("relatorio-saude.pdf");
      Swal.fire({ icon: 'success', title: 'PDF gerado!', text: 'Relatório salvo com sucesso.', timer: 1600, showConfirmButton: false });
    });

    // ======== PROFISSIONAIS (AGENDA) ========
    const agendaDataEl = document.getElementById("agendaData");
    const btnHoje = document.getElementById("btnHoje");
    const btnAgendaMedico = document.getElementById("btnAgendaMedico");
    const btnAgendaEnfermeiro = document.getElementById("btnAgendaEnfermeiro");
    const tabelaAgendaBody = document.querySelector("#tabelaAgenda tbody");
    const vagasInfo = document.getElementById("vagasInfo");
    const buscaAgenda = document.getElementById("buscaAgenda");

    function formatISODateOnly(d) {
      const pad = n => String(n).padStart(2, '0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }
    function formatDateBR(dateStr) {
      const [y,m,d] = dateStr.split("-");
      return `${d}/${m}/${y}`;
    }
    function isWeekday(dateStr) {
      const d = new Date(dateStr + "T00:00:00");
      const day = d.getDay(); // 0=Dom, 6=Sáb
      return day >= 1 && day <= 5;
    }
    function initAgendaDefaults() {
      if (!agendaDataEl.value) {
        agendaDataEl.value = formatISODateOnly(new Date());
      }
      updateVagasInfo();
    }
    btnHoje.addEventListener("click", () => {
      agendaDataEl.value = formatISODateOnly(new Date());
      renderAgenda();
    });
    agendaDataEl.addEventListener("change", () => {
      if (!agendaDataEl.value) return;
      renderAgenda();
    });
    buscaAgenda.addEventListener("input", () => renderAgenda());

    function getAgendaAll() { return encLoad(KEY_AGD, []); }
    function getAgendaByDate(dateStr) {
      const all = getAgendaAll();
      return all.filter(a => a.data === dateStr);
    }
    function saveAgendaAll(list) { encSave(KEY_AGD, list); }

    function updateVagasInfo() {
      const data = agendaDataEl.value;
      const items = getAgendaByDate(data);
      const medicos = items.filter(i => i.tipo === "medico").length;
      const enferms = items.filter(i => i.tipo === "enfermeiro").length;
      vagasInfo.textContent = `Vagas em ${formatDateBR(data)}: Médico(a) ${medicos}/10 • Enfermeiro(a) ${enferms}/15`;
    }

    function solicitarMedicoNome() {
      return Swal.fire({
        title: "Escolha o médico",
        input: "select",
        inputOptions: { "Dra. Ana": "Dra. Ana", "Dr. Kaka": "Dr. Kaka" },
        inputPlaceholder: "Selecione",
        showCancelButton: true,
        confirmButtonText: "Continuar"
      });
    }

    function abrirAgendar(tipo) {
      const data = agendaDataEl.value;
      if (!data) { Swal.fire("Selecione a data", "Informe uma data para agendar.", "info"); return; }
      if (!isWeekday(data)) { Swal.fire("Data inválida", "Escolha um dia útil (segunda a sexta).", "warning"); return; }

      const items = getAgendaByDate(data);
      const limite = (tipo === "medico") ? 10 : 15;
      const atual = items.filter(i => i.tipo === tipo).length;
      if (atual >= limite) {
        Swal.fire("Limite atingido", `Todas as ${limite} vagas já foram preenchidas para ${tipo === "medico" ? "Médico(a)" : "Enfermeiro(a)"} em ${formatDateBR(data)}.`, "warning");
        return;
      }

      if (pacienteSelecionado) {
        if (tipo === "medico") {
          solicitarMedicoNome().then(res => {
            if (!res.isConfirmed || !res.value) return;
            salvarAgendamentoComPaciente(tipo, res.value, pacienteSelecionado, data);
          });
        } else {
          salvarAgendamentoComPaciente(tipo, "Enfermeiro(a)", pacienteSelecionado, data);
        }
        return;
      }

      if (tipo === "medico") {
        solicitarMedicoNome().then(res => {
          if (!res.isConfirmed || !res.value) return;
          abrirFormularioAgendamento(tipo, res.value, data);
        });
      } else {
        abrirFormularioAgendamento(tipo, "Enfermeiro(a)", data);
      }
    }

    btnAgendaMedico.addEventListener("click", () => abrirAgendar("medico"));
    btnAgendaEnfermeiro.addEventListener("click", () => abrirAgendar("enfermeiro"));

    function abrirFormularioAgendamento(tipo, profissional, data) {
      Swal.fire({
        title: `Agendar - ${profissional}`,
        html: `
          <input id="ag-nome" class="swal2-input" placeholder="Nome do paciente">
          <input id="ag-endereco" class="swal2-input" placeholder="Endereço">
          <input id="ag-cpf" class="swal2-input" placeholder="CPF">
          <input id="ag-telefone" class="swal2-input" placeholder="Telefone">
          <input id="ag-agente" class="swal2-input" placeholder="Agente de Saúde">
        `,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: "Salvar",
        preConfirm: () => {
          const nome = document.getElementById("ag-nome").value.trim();
          if (!nome) { Swal.showValidationMessage("Informe o nome do paciente"); return false; }
          return {
            id: Date.now(),
            tipo,
            profissional,
            data,
            criadoISO: new Date().toISOString(),
            nome,
            endereco: document.getElementById("ag-endereco").value.trim(),
            cpf: document.getElementById("ag-cpf").value.trim(),
            telefone: document.getElementById("ag-telefone").value.trim(),
            agente: document.getElementById("ag-agente").value.trim()
          };
        }
      }).then(res => {
        if (!res.isConfirmed) return;
        const all = getAgendaAll();
        all.push(res.value);
        saveAgendaAll(all);
        Swal.fire({ icon:"success", title:"Consulta agendada!", timer:1200, showConfirmButton:false });
        renderAgenda();
      });
    }

    function salvarAgendamentoComPaciente(tipo, profissional, paciente, data) {
      const all = getAgendaAll();
      const novo = {
        id: Date.now(),
        tipo,
        profissional,
        data,
        criadoISO: new Date().toISOString(),
        nome: paciente.nome,
        endereco: paciente.endereco || "",
        cpf: paciente.cpf || "",
        telefone: paciente.telefone || "",
        agente: paciente.agente || ""
      };
      all.push(novo);
      saveAgendaAll(all);
      Swal.fire({ icon:"success", title:"Consulta agendada!", timer:1000, showConfirmButton:false });
      renderAgenda();
    }

    function renderAgenda() {
      const data = agendaDataEl.value;
      let items = getAgendaByDate(data).sort((a,b) => new Date(a.criadoISO) - new Date(b.criadoISO));
      const termo = (buscaAgenda.value||"").toLowerCase().trim();
      if (termo) {
        items = items.filter(c =>
          (c.nome||"").toLowerCase().includes(termo) ||
          (c.cpf||"").toLowerCase().includes(termo) ||
          (c.agente||"").toLowerCase().includes(termo)
        );
      }

      const tbody = document.querySelector("#tabelaAgenda tbody");
      tbody.innerHTML = "";
      updateVagasInfo();

      if (items.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="9" class="muted"><i class="fa-regular fa-folder-open"></i> Nenhuma consulta para ${formatDateBR(data)}.</td>`;
        tbody.appendChild(tr);
        return;
      }

      items.forEach((c, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${formatDateBR(c.data)}</td>
          <td>${c.profissional}</td>
          <td>${c.nome}</td>
          <td>${c.endereco || "--"}</td>
          <td>${c.cpf || "--"}</td>
          <td>${c.telefone || "--"}</td>
          <td>${c.agente || "--"}</td>
          <td>
            <button class="btn secondary" title="Editar" data-act="edit"><i class="fa-solid fa-pen"></i></button>
            <button class="btn btn-remove" title="Remover" data-act="del"><i class="fa-solid fa-trash"></i></button>
          </td>
        `;
        tr.querySelector('[data-act="edit"]').addEventListener("click", () => editarConsulta(c.id));
        tr.querySelector('[data-act="del"]').addEventListener("click", () => removerConsulta(c.id));
        tbody.appendChild(tr);
      });
    }

    function editarConsulta(id) {
      const all = getAgendaAll();
      const c = all.find(x => x.id === id);
      if (!c) return;
      Swal.fire({
        title: `Editar - ${c.profissional}`,
        html: `
          <input id="ag-nome" class="swal2-input" value="${c.nome}">
          <input id="ag-endereco" class="swal2-input" value="${c.endereco || ""}">
          <input id="ag-cpf" class="swal2-input" value="${c.cpf || ""}">
          <input id="ag-telefone" class="swal2-input" value="${c.telefone || ""}">
          <input id="ag-agente" class="swal2-input" value="${c.agente || ""}">
          <input id="ag-data" type="date" class="swal2-input" value="${c.data}">
        `,
        showCancelButton: true,
        confirmButtonText: "Salvar",
        preConfirm: () => {
          const nome = document.getElementById("ag-nome").value.trim();
          if (!nome) { Swal.showValidationMessage("Informe o nome do paciente"); return false; }
          c.nome = nome;
          c.endereco = document.getElementById("ag-endereco").value.trim();
          c.cpf = document.getElementById("ag-cpf").value.trim();
          c.telefone = document.getElementById("ag-telefone").value.trim();
          c.agente = document.getElementById("ag-agente").value.trim();
          const novaData = document.getElementById("ag-data").value;
          if (novaData) c.data = novaData;
        }
      }).then(res => {
        if (!res.isConfirmed) return;
        saveAgendaAll(all);
        Swal.fire({ icon:"success", title:"Consulta atualizada!", timer:1000, showConfirmButton:false });
        renderAgenda();
      });
    }

    function removerConsulta(id) {
      let all = getAgendaAll();
      all = all.filter(c => c.id !== id);
      saveAgendaAll(all);
      renderAgenda();
      Swal.fire({ icon:"success", title:"Consulta removida!", timer:1000, showConfirmButton:false });
    }

    document.getElementById("btnExportAgenda").addEventListener("click", () => {
      const data = agendaDataEl.value || formatISODateOnly(new Date());
      const items = getAgendaByDate(data).sort((a,b) => new Date(a.criadoISO) - new Date(b.criadoISO));
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFillColor(37,99,235);
      doc.rect(0,0,210,20,"F");
      doc.setFontSize(16);
      doc.setTextColor(255,255,255);
      doc.text(`Agenda - ${formatDateBR(data)}`, 14, 14);
      doc.setTextColor(0,0,0);
      doc.setFontSize(11);
      doc.text("Gerado em: " + new Date().toLocaleString("pt-BR"), 14, 28);

      let y = 40;
      const totalMed = items.filter(i => i.tipo==="medico").length;
      const totalEnf = items.filter(i => i.tipo==="enfermeiro").length;
      doc.text(`Total Médico(a): ${totalMed}/10`, 14, y); y+=6;
      doc.text(`Total Enfermeiro(a): ${totalEnf}/15`, 14, y); y+=10;

      if (items.length === 0) {
        doc.text("Nenhuma consulta para a data.", 14, y);
      } else {
        items.forEach((c, i) => {
          doc.setFontSize(12);
          doc.text(`${i+1}. ${c.profissional} - ${c.nome}`, 14, y); y += 6;
          doc.text(`End.: ${c.endereco || "--"} | CPF: ${c.cpf || "--"} | Tel.: ${c.telefone || "--"} | Agente: ${c.agente || "--"}`, 14, y); y += 10;
          if (y > 270) { doc.addPage(); y = 20; }
        });
      }

      // Linha de assinatura no final
      y += 20; if (y > 280) { doc.addPage(); y = 20; }
      doc.line(14, y, 100, y); y += 6;
      doc.text("Assinatura do profissional", 14, y);

      doc.save(`agenda_${formatDateBR(data)}.pdf`);
      Swal.fire({ icon:"success", title:"PDF da agenda gerado!", timer:1200, showConfirmButton:false });
    });

    document.getElementById("btnLimparAgenda").addEventListener("click", () => {
      const data = agendaDataEl.value || formatISODateOnly(new Date());
      Swal.fire({
        title: `Limpar agenda de ${formatDateBR(data)}?`,
        text: "Essa ação remove todas as consultas dessa data.",
        icon: "warning", showCancelButton:true, confirmButtonText:"Apagar", cancelButtonText:"Cancelar"
      }).then(res => {
        if (!res.isConfirmed) return;
        const all = getAgendaAll();
        const keep = all.filter(c => c.data !== data);
        saveAgendaAll(keep);
        renderAgenda();
        Swal.fire({ icon:"success", title:"Agenda do dia apagada!", timer:1000, showConfirmButton:false });
      });
    });

    // ======== EXAMES LABORATORIAIS (POP-UP + PDF) ========
document.getElementById("btnExamesLab").addEventListener("click", () => {
  Swal.fire({
    title: "Exames laboratoriais",
    width: 800, // pop-up mais largo
    html: `
      <div style="text-align:left; max-height:420px; overflow-y:auto;">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
          <!-- Coluna Esquerda -->
          <div class="exams-list">
            <label><input type="checkbox" id="exa1"> Parasitológico de Fezes</label>
            <label><input type="checkbox" id="exa2"> Sumário de Urina</label>
            <label><input type="checkbox" id="exa3"> Glicosúria</label>
            <label><input type="checkbox" id="exa4"> Teste de Gravidez</label>
            <label><input type="checkbox" id="exa5"> Hemograma Completo</label>
            <label><input type="checkbox" id="exa6"> Tipagem Sanguínea</label>
            <label><input type="checkbox" id="exa7"> Prova do Laço</label>
            <label><input type="checkbox" id="exa8"> Tempo de Sangria</label>
            <label><input type="checkbox" id="exa9"> Tempo de Coagulação</label>
            <label><input type="checkbox" id="exa10"> Glicemia em Jejum</label>
            <label><input type="checkbox" id="exa11"> Glicemia pós Prandial</label>
            <label><input type="checkbox" id="exa12"> Colesterol Total</label>
            <label><input type="checkbox" id="exa13"> Sorologia p/ Lues</label>
            <label><input type="checkbox" id="exa14"> Uréia</label>
            <label><input type="checkbox" id="exa15"> Creatinina</label>
            <label><input type="checkbox" id="exa16"> Ácido Úrico</label>
            <label><input type="checkbox" id="exa17"> Pesquisa de BAAR</label>
            <label><input type="checkbox" id="exa18"> Bilirrubina Total</label>
            <label><input type="checkbox" id="exa19"> TGP TGO</label>
            <label><input type="checkbox" id="exa20"> Secc. Vaginal</label>
            <label><input type="checkbox" id="exa21"> Lipídios Totais</label>
          </div>

          <!-- Coluna Direita -->
          <div class="exams-list">
            <label><input type="checkbox" id="exa22"> Triglicerídeos</label>
            <label><input type="checkbox" id="exa23"> Látex</label>
            <label><input type="checkbox" id="exa24"> Aslo</label>
            <label><input type="checkbox" id="exa25"> Mucoproteína</label>
            <label><input type="checkbox" id="exa26"> VHS</label>
            <label><input type="checkbox" id="exa27"> PCR</label>
            <label><input type="checkbox" id="exa28"> Outros</label>
          </div>
        </div>

        <div style="margin-top:12px;">
          <label for="obsExames"><strong>Observações / Especificar:</strong></label>
          <textarea id="obsExames" rows="3" style="width:100%;"></textarea>
        </div>
      </div>
    `,
    showCancelButton: true,
    confirmButtonText: "Salvar em PDF",
    preConfirm: () => {
      const labels = [
        "Parasitológico de Fezes","Sumário de Urina","Glicosúria","Teste de Gravidez","Hemograma Completo",
        "Tipagem Sanguínea","Prova do Laço","Tempo de Sangria","Tempo de Coagulação","Glicemia em Jejum",
        "Glicemia pós Prandial","Colesterol Total","Sorologia p/ Lues","Uréia","Creatinina","Ácido Úrico",
        "Pesquisa de BAAR","Bilirrubina Total","TGP TGO","Secc. Vaginal","Lipídios Totais",
        "Triglicerídeos","Látex","Aslo","Mucoproteína","VHS","PCR","Outros"
      ];
      const exames = [];
      for (let i=1;i<=28;i++) {
        const el = document.getElementById("exa"+i);
        if (el && el.checked) exames.push(labels[i-1]);
      }
      const obs = (document.getElementById("obsExames").value || "").trim();
      if (exames.length===0 && !obs) {
        Swal.showValidationMessage("Selecione pelo menos um exame ou informe observações.");
        return false;
      }
      return { exames, obs };
    }
  }).then(res => {
    if (!res.isConfirmed) return;
    solicitarMedicoNome().then(med => {
      const medicoNome = med.isConfirmed && med.value ? med.value : "Médico(a)";
      gerarPDFExames(res.value.exames, res.value.obs, medicoNome);
    });
  });
});

    function gerarPDFExames(exames, observacoes, medicoNome="Médico(a)") {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Cabeçalho moderno
      doc.setFillColor(37,99,235);
      doc.rect(0,0,210,20,"F");
      doc.setFontSize(16);
      doc.setTextColor(255,255,255);
      doc.text("Solicitação de Exames Laboratoriais", 14, 14);

      // Informações do paciente selecionado
      doc.setTextColor(0,0,0);
      doc.setFontSize(11);
      const hoje = new Date();
      doc.text("Data: " + hoje.toLocaleDateString("pt-BR"), 14, 28);

      let y = 36;
      if (pacienteSelecionado) {
        doc.setFontSize(12);
        doc.text(`Nome: ${pacienteSelecionado.nome || "--"}`, 14, y); y+=6;
        doc.text(`Nascimento: ${pacienteSelecionado.nascimento || "--"} | CPF: ${pacienteSelecionado.cpf || "--"}`, 14, y); y+=6;
        doc.text(`Endereço: ${pacienteSelecionado.endereco || "--"}`, 14, y); y+=6;
        doc.text(`Telefone: ${pacienteSelecionado.telefone || "--"} | Agente: ${pacienteSelecionado.agente || "--"}`, 14, y); y+=10;
      } else {
        doc.setFontSize(12);
        doc.text(`Paciente: --`, 14, y); y+=10;
      }

      // Médico responsável
      doc.setFontSize(12);
      doc.text(`Médico responsável: ${medicoNome}`, 14, y); y+=10;

      // Lista de exames
      doc.setFontSize(13);
      doc.text("Exames solicitados:", 14, y); y+=8;
      doc.setFontSize(12);
      if (exames.length === 0) {
        doc.text("Nenhum exame selecionado.", 20, y); y += 8;
      } else {
        exames.forEach((ex, i) => {
          doc.text(`${i+1}. ${ex}`, 20, y);
          y+=8;
          if (y > 270) { doc.addPage(); y = 20; }
        });
      }

      // Observações
      if (observacoes) {
        y+=6;
        doc.setFontSize(13);
        doc.text("Observações:", 14, y); y+=8;
        doc.setFontSize(12);
        const lines = doc.splitTextToSize(observacoes, 180);
        doc.text(lines, 14, y);
        y += lines.length * 6;
      }

      // Linha de assinatura
      y+=20; if (y > 280) { doc.addPage(); y = 20; }
      doc.line(14, y, 100, y); y+=6;
      doc.text("Assinatura do médico", 14, y);

      doc.save("exames-laboratoriais.pdf");
      Swal.fire({ icon:"success", title:"PDF gerado!", timer:1500, showConfirmButton:false });
    }

    // ======== PERSISTÊNCIA LOGIN ========
    window.addEventListener("DOMContentLoaded", () => {
      const logado = localStorage.getItem(KEY_LOGGED) === "true";
      const senhaSalva = localStorage.getItem(KEY_PASS);
      if (logado && senhaSalva) {
        SECRET = senhaSalva;
        document.getElementById("loginScreen").style.display = "none";
        document.getElementById("appRoot").style.display = "block";
        setActiveTab("tab-dados");
        renderListaPacientes();
        carregarPacientesSelect();
        carregarHistorico();
        initAgendaDefaults();
        renderAgenda();
      } else {
        document.getElementById("loginScreen").style.display = "flex";
        document.getElementById("appRoot").style.display = "none";
      }
      showHintIfExists();
    });
  </script>
</body>
</html>
